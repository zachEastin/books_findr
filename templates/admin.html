<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Price Tracker - Admin</title>

    <!-- Material Design CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <style>
        .admin-card {
            margin: 20px 0;
        }        .isbn-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .isbn-item:last-child {
            border-bottom: none;
        }

        .isbn-info {
            flex-grow: 1;
            margin-right: 15px;
        }

        .isbn-number {
            margin-bottom: 5px;
        }

        .book-title {
            font-weight: 500;
            color: #1976d2;
            margin-bottom: 3px;
        }

        .book-meta {
            font-size: 0.9em;
            line-height: 1.3;
        }

        .isbn-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #4CAF50;
        }

        .status-error {
            background-color: #f44336;
        }

        .status-pending {
            background-color: #ff9800;
        }
    </style>
</head>

<body class="grey lighten-4">
    <!-- Navigation -->
    <nav class="blue darken-3">
        <div class="nav-wrapper container">
            <a href="/" class="brand-logo">
                <i class="material-icons left">trending_up</i>Book Price Tracker
            </a>
            <ul class="right hide-on-med-and-down">
                <li><a href="/"><i class="material-icons left">dashboard</i>Dashboard</a></li>
                <li class="active"><a href="/admin"><i class="material-icons left">settings</i>Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col s12">
                <h4 class="blue-text text-darken-3">
                    <i class="material-icons left">settings</i>Administration Panel
                </h4>
                <p class="grey-text">Manage ISBNs and scraping operations</p>
            </div>
        </div>

        <!-- Add ISBN Section -->
        <div class="row">
            <div class="col s12 m6">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">add</i>Add New ISBN
                        </span>
                        <div class="row">
                            <div class="col s12">
                                <ul class="tabs">
                                    <li class="tab col s6"><a class="active" href="#add-by-isbn">ISBN</a></li>
                                    <li class="tab col s6"><a href="#add-by-title">Title</a></li>
                                </ul>
                            </div>
                            <div id="add-by-isbn" class="col s12" style="margin-top: 20px;">
                                <div class="input-field">
                                    <input id="new-title-isbn" type="text" required>
                                    <label for="new-title-isbn">Book Title <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <input id="new-isbn" type="text" required>
                                    <label for="new-isbn">ISBN <span class="red-text">*</span></label>
                                </div>
                                <button class="btn blue waves-effect waves-light" onclick="addISBN('isbn')">
                                    <i class="material-icons left">add</i>Add by ISBN
                                </button>
                            </div>
                            <div id="add-by-title" class="col s12" style="margin-top: 20px;">
                                <div class="input-field">
                                    <input id="new-title-title" type="text" required>
                                    <label for="new-title-title">Book Title <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <input id="new-author" type="text" required>
                                    <label for="new-author">Author <span class="red-text">*</span></label>
                                </div>
                                <button class="btn blue waves-effect waves-light" onclick="addISBN('title')">
                                    <i class="material-icons left">add</i>Add by Title & Author
                                </button>
                                <div class="grey-text" style="margin-top:10px;">Both title and author are required to add by title.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col s12 m6">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">flash_on</i>Quick Actions
                        </span>
                        <p>Perform bulk operations</p>
                    </div>
                    <div class="card-action">
                        <button class="btn green waves-effect waves-light" onclick="scrapeAll()">
                            <i class="material-icons left">sync</i>Scrape All
                        </button>
                        <button class="btn orange waves-effect waves-light" onclick="loadISBNs()">
                            <i class="material-icons left">refresh</i>Refresh List
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ISBN List -->
        <div class="row">
            <div class="col s12">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">list</i>Tracked ISBNs
                            <span class="badge blue white-text" id="isbn-count">0</span>
                        </span>
                        <div id="isbn-list" class="collection">
                            <!-- ISBNs will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col s12">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">history</i>Recent Activity
                        </span>
                        <div id="activity-log">
                            <div class="grey-text">Loading recent activity...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Material Design JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        // Initialize Materialize components
        document.addEventListener('DOMContentLoaded', function () {
            M.AutoInit();
            var el = document.querySelectorAll('.tabs');
            M.Tabs.init(el);
            loadISBNs();
            loadActivity();
        });        // Load ISBNs

        // Add new ISBN or by title/author
        async function addISBN(mode) {
            let title = "";
            let isbn = "";
            let author = "";
            if (mode === 'isbn') {
                title = document.getElementById('new-title-isbn').value.trim();
                isbn = document.getElementById('new-isbn').value.trim();
                if (!title) {
                    M.toast({ html: 'Please enter a title', classes: 'orange' });
                    return;
                }
                if (!isbn) {
                    M.toast({ html: 'Please enter an ISBN', classes: 'orange' });
                    return;
                }
            } else {
                title = document.getElementById('new-title-title').value.trim();
                author = document.getElementById('new-author').value.trim();
                if (!title) {
                    M.toast({ html: 'Please enter a title', classes: 'orange' });
                    return;
                }
                if (!author) {
                    M.toast({ html: 'Please enter an author', classes: 'orange' });
                    return;
                }
            }
            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        isbn: mode === 'isbn' ? isbn : '',
                        author: mode === 'title' ? author : ''
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    if (mode === 'isbn') {
                        document.getElementById('new-title-isbn').value = '';
                        document.getElementById('new-isbn').value = '';
                    } else {
                        document.getElementById('new-title-title').value = '';
                        document.getElementById('new-author').value = '';
                    }
                    loadISBNs();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error adding ISBN:', error);
                M.toast({ html: 'Error adding ISBN', classes: 'red' });
            }
        }

        // Remove ISBN
        async function removeISBN(title, isbn) {
            if (!confirm(`Remove ISBN ${isbn} from ${title}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/books/${encodeURIComponent(title)}/${isbn}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadISBNs();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error removing ISBN:', error);
                M.toast({ html: 'Error removing ISBN', classes: 'red' });
            }
        }

        // Scrape specific ISBN
        async function scrapeISBN(isbn) {
            M.toast({ html: `Starting scrape for ${isbn}...`, classes: 'blue' });

            try {
                const response = await fetch(`/api/scrape/${isbn}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadActivity();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error scraping ISBN:', error);
                M.toast({ html: 'Error scraping ISBN', classes: 'red' });
            }
        }
        
        // Scrape all ISBNs
        async function scrapeAll() {
            M.toast({ html: 'Starting scrape for all ISBNs...', classes: 'blue' });

            try {
                const response = await fetch('/api/scrape/all', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadActivity();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error scraping all ISBNs:', error);
                M.toast({ html: 'Error scraping all ISBNs', classes: 'red' });
            }
        }

        // Load ISBNs
        async function loadISBNs() {
            const isbnCount = document.getElementById('isbn-count');
            isbnCount.textContent = '0'; // Reset count
            const isbnList = document.getElementById('isbn-list');
            isbnList.innerHTML = '<div class="grey-text">Loading ISBNs...</div>';

            try {
                const response = await fetch('/api/books');
                if (response.ok) {
                    const data = await response.json();
                    isbnCount.textContent = Object.keys(data).length.toString();
                    if (data && Object.keys(data).length > 0) {
                        let html = '';
                        Object.entries(data).forEach(([title, items]) => {
                            items.forEach(item => {
                                const isbn = Object.keys(item)[0];
                                const meta = item[isbn] || {};
                                const googleBooksUrl = isbn ? `https://www.google.com/search?tbm=bks&q=isbn:${isbn}` : '#';
                                html += `
                                <div class="isbn-item">
                                    <div class="isbn-info">
                                        <div class="book-title">${title}</div>
                                        <div class="isbn-number">
                                            <a href="${googleBooksUrl}" target="_blank" rel="noopener" style="font-weight:bold; color:#1976d2; text-decoration:underline;">${isbn}</a>
                                        </div>
                                        <div class="book-meta">
                                            ${meta.authors && meta.authors.length ? 'by ' + meta.authors.join(', ') : ''}
                                            ${meta.year ? ' â€¢ ' + meta.year : ''}
                                        </div>
                                    </div>
                                    <div class="isbn-actions">
                                        <button class="btn-flat red-text" onclick="removeISBN('${title.replace(/'/g, "\\'")}', '${isbn}')" title="Remove"><i class="material-icons">delete</i></button>
                                        <button class="btn-flat blue-text" onclick="scrapeISBN('${isbn}')" title="Scrape"><i class="material-icons">sync</i></button>
                                    </div>
                                </div>
                                `;
                            });
                        });
                        isbnList.innerHTML = html;
                    } else {
                        isbnList.innerHTML = '<div class="grey-text">No ISBNs found</div>';
                    }
                } else {
                    // Handle non-200 responses
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    isbnList.innerHTML = '<div class="red-text">Error loading ISBNs</div>';
                }
            } catch (error) {
                console.error('Error loading ISBNs:', error);
                isbnList.innerHTML = '<div class="red-text">Failed to load ISBNs. Please check the console for details.</div>';
            }
        }

        // Load recent activity
        async function loadActivity() {
            const activityLog = document.getElementById('activity-log');
            
            try {
                const response = await fetch('/api/prices/recent');
                if (response.ok) {
                    const data = await response.json();
                    true;
                    if (data && data.length > 0) {
                        activityLog.innerHTML = data.map(record => {
                            // Handle aN values safely
                            const isbn = record.isbn || 'Unknown ISBN';
                            const source = record.source || 'Unknown Source';
                            const price = (record.price !== null && record.price !== undefined && !isNaN(record.price)) 
                                ? record.price 
                                : null;
                            const timestamp = record.timestamp ? new Date(record.timestamp).toLocaleString() : 'Unknown time';
                            const title = record.title && record.title !== 'NaN' ? ` - ${record.title}` : '';

                            return `
                                <div class="activity-item" style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${isbn}</strong>${title} from ${source}
                                            ${price !== null ? `<span class="green-text"> - $${price}</span>` : '<span class="red-text"> - Failed</span>'}
                                        </div>
                                        <small class="grey-text">${timestamp}</small>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        activityLog.innerHTML = '<div class="grey-text">No recent activity found</div>';
                    }
                } else {
                    // Handle non-200 responses
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    activityLog.innerHTML = '<div class="red-text">Error loading recent activity</div>';
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                activityLog.innerHTML = '<div class="red-text">Failed to load recent activity. Please check the console for details.</div>';
            }
        }        // Enter key support for ISBN input
        document.getElementById('new-isbn').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addISBN();
            }
        });
        document.getElementById('new-title').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addISBN();
            }
        });

        // Load image for specific ISBN
        async function loadImageForISBN(isbn) {
            const imageId = `image-${isbn.replace(/[^a-zA-Z0-9]/g, '')}`;
            const imageElement = document.getElementById(imageId);
            
            if (!imageElement) return;
            
            try {
                const response = await fetch(`/api/images/${isbn}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Find the first available image
                    let imageFound = false;
                    for (const [source, imageInfo] of Object.entries(data.images)) {
                        if (imageInfo.exists) {
                            imageElement.innerHTML = `<img src="${imageInfo.url}" alt="Book cover" class="book-image">`;
                            imageFound = true;
                            break;
                        }
                    }
                    
                    if (!imageFound) {
                        imageElement.innerHTML = 'No Image';
                    }
                } else {
                    imageElement.innerHTML = 'No Image';
                }
            } catch (error) {
                console.error('Error loading image for ISBN:', isbn, error);
                imageElement.innerHTML = 'No Image';
            }
        }

        // Download image for specific ISBN and source
        async function downloadImage(isbn, source) {
            M.toast({ html: `Downloading image for ${isbn} from ${source}...`, classes: 'blue' });
            
            try {
                const response = await fetch(`/api/images/${isbn}/${source}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    // Reload the image for this ISBN
                    loadImageForISBN(isbn);
                } else {
                    M.toast({ html: data.error || 'Failed to download image', classes: 'red' });
                }
            } catch (error) {
                console.error('Error downloading image:', error);
                M.toast({ html: 'Error downloading image', classes: 'red' });
            }
        }
    </script>
</body>

</html>