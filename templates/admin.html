<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Price Tracker - Admin</title>

    <!-- Material Design CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <style>
        .admin-card {
            margin: 20px 0;
        }        .isbn-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .isbn-item:last-child {
            border-bottom: none;
        }

        .isbn-info {
            flex-grow: 1;
            margin-right: 15px;
        }

        .isbn-number {
            margin-bottom: 5px;
        }

        .book-title {
            font-weight: 500;
            color: #1976d2;
            margin-bottom: 3px;
        }

        .book-meta {
            font-size: 0.9em;
            line-height: 1.3;
        }

        .isbn-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #4CAF50;
        }

        .status-error {
            background-color: #f44336;
        }

        .status-pending {
            background-color: #ff9800;
        }

        .isbn-group {
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #fff;
        }

        .isbn-group-header {
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .isbn-group-header:hover {
            background-color: #f5f5f5;
        }

        .isbn-group-list {
            display: none;
            padding: 0 10px 10px;
        }

        .isbn-item-subgroup {
            background: #f0f2f6;
            max-width: 92%;
            margin-left: 5%;
            border-left: 5px solid #667eea;
            border-radius: 6px;
            box-shadow: 0 1px 2px #e0e0e0;
            padding: 13px 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .isbn-item-subgroup:hover {
            background: #e3e6ee !important;
            box-shadow: 0 2px 6px #d0d3db;
        }        /* Rotating animation for sync icon */
        .rotating {
            animation: rotating 1s linear infinite;
        }
        @keyframes rotating {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        /* Grade content styling */
        .grade-content {
            padding-top: 20px;
        }

        .grade-content h6 {
            margin-bottom: 15px;
        }

        /* Responsive tab styling */
        .tabs .tab {
            min-width: 60px;
        }
        
        .tabs .tab a {
            font-size: 12px;
            padding: 0 8px;
        }        @media only screen and (max-width: 992px) {
            .tabs .tab a {
                font-size: 10px;
                padding: 0 4px;
            }
        }

        /* Fix dropdown clipping issues */
        .dropdown-content {
            z-index: 9999 !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.25) !important;
        }

        /* Ensure parent containers don't clip dropdowns */
        .card-content,
        .collection,
        .isbn-group,
        .isbn-group-list,
        .grade-content {
            overflow: visible !important;
        }

        /* Fix for tab content containers */
        .tabs .tab-content {
            overflow: visible !important;
        }
    </style>
</head>

<body class="grey lighten-4"></body>
    <!-- Navigation -->
    <nav class="blue darken-3">
        <div class="nav-wrapper container">
            <a href="/" class="brand-logo">
                <i class="material-icons left">trending_up</i>Book Price Tracker
            </a>
            <ul class="right hide-on-med-and-down">
                <li><a href="/"><i class="material-icons left">dashboard</i>Dashboard</a></li>
                <li class="active"><a href="/admin"><i class="material-icons left">settings</i>Admin</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col s12">
                <h4 class="blue-text text-darken-3">
                    <i class="material-icons left">settings</i>Administration Panel
                </h4>
                <p class="grey-text">Manage ISBNs and scraping operations</p>
            </div>
        </div>

        <!-- Add ISBN Section -->
        <div class="row">
            <div class="col s12 m6">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">add</i>Add New ISBN
                        </span>
                        <div class="row">
                            <div class="col s12">
                                <ul class="tabs">
                                    <li class="tab col s6"><a class="active" href="#add-by-isbn">ISBN</a></li>
                                    <li class="tab col s6"><a href="#add-by-title">Title</a></li>
                                </ul>
                            </div>                            <div id="add-by-isbn" class="col s12" style="margin-top: 20px;">
                                <div class="input-field">
                                    <input id="new-title-isbn" type="text" required>
                                    <label for="new-title-isbn">Book Title</label>
                                </div>
                                <div class="input-field">
                                    <input id="new-isbn" type="text" required>
                                    <label for="new-isbn">ISBN <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <select id="grade-level-isbn">
                                        <option value="" disabled selected>Select Grade Level (Optional)</option>
                                        <option value="Kindergarten">Kindergarten</option>
                                        <option value="1st Grade">1st Grade</option>
                                        <option value="2nd Grade">2nd Grade</option>
                                        <option value="3rd Grade">3rd Grade</option>
                                        <option value="4th Grade">4th Grade</option>
                                        <option value="5th Grade">5th Grade</option>
                                        <option value="6th Grade">6th Grade</option>
                                        <option value="7th Grade">7th Grade</option>
                                        <option value="8th Grade">8th Grade</option>
                                        <option value="9th Grade">9th Grade</option>
                                        <option value="10th Grade">10th Grade</option>
                                        <option value="11th Grade">11th Grade</option>
                                        <option value="12th Grade">12th Grade</option>
                                    </select>
                                    <label>Grade Level</label>
                                </div>
                                <button class="btn blue waves-effect waves-light" onclick="addISBN('isbn')">
                                    <i class="material-icons left">add</i>Add by ISBN
                                </button>
                            </div>                            <div id="add-by-title" class="col s12" style="margin-top: 20px;">
                                <div class="input-field">
                                    <input id="new-title-title" type="text" required>
                                    <label for="new-title-title">Book Title <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <input id="new-author" type="text" required>
                                    <label for="new-author">Author <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <select id="grade-level-title">
                                        <option value="" disabled selected>Select Grade Level (Optional)</option>
                                        <option value="Kindergarten">Kindergarten</option>
                                        <option value="1st Grade">1st Grade</option>
                                        <option value="2nd Grade">2nd Grade</option>
                                        <option value="3rd Grade">3rd Grade</option>
                                        <option value="4th Grade">4th Grade</option>
                                        <option value="5th Grade">5th Grade</option>
                                        <option value="6th Grade">6th Grade</option>
                                        <option value="7th Grade">7th Grade</option>
                                        <option value="8th Grade">8th Grade</option>
                                        <option value="9th Grade">9th Grade</option>
                                        <option value="10th Grade">10th Grade</option>
                                        <option value="11th Grade">11th Grade</option>
                                        <option value="12th Grade">12th Grade</option>
                                    </select>
                                    <label>Grade Level</label>
                                </div>
                                <button class="btn blue waves-effect waves-light" onclick="addISBN('title')">
                                    <i class="material-icons left">add</i>Add by Title & Author
                                </button>
                                <div class="grey-text" style="margin-top:10px;">Both title and author are required to add by title.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col s12 m6">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">flash_on</i>Quick Actions
                        </span>
                        <p>Perform bulk operations</p>
                    </div>
                    <div class="card-action">
                        <button class="btn green waves-effect waves-light" onclick="scrapeAll()">
                            <i class="material-icons left">sync</i>Scrape All
                        </button>
                        <button class="btn orange waves-effect waves-light" onclick="loadISBNs()">
                            <i class="material-icons left">refresh</i>Refresh List
                        </button>
                    </div>
                </div>
            </div>
        </div>        <!-- Grade Level Book Organization -->
        <div class="row">
            <div class="col s12">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">school</i>Books by Grade Level
                            <span class="badge blue white-text" id="isbn-count">0</span>
                        </span>
                        
                        <!-- Grade Level Tabs -->
                        <div class="row">
                            <div class="col s12">
                                <ul class="tabs" id="grade-tabs">
                                    <li class="tab col"><a class="active" href="#unassigned-books">Unassigned</a></li>
                                    <li class="tab col"><a href="#kindergarten-books">K</a></li>
                                    <li class="tab col"><a href="#grade-1-books">1st</a></li>
                                    <li class="tab col"><a href="#grade-2-books">2nd</a></li>
                                    <li class="tab col"><a href="#grade-3-books">3rd</a></li>
                                    <li class="tab col"><a href="#grade-4-books">4th</a></li>
                                    <li class="tab col"><a href="#grade-5-books">5th</a></li>
                                    <li class="tab col"><a href="#grade-6-books">6th</a></li>
                                    <li class="tab col"><a href="#grade-7-books">7th</a></li>
                                    <li class="tab col"><a href="#grade-8-books">8th</a></li>
                                    <li class="tab col"><a href="#grade-9-books">9th</a></li>
                                    <li class="tab col"><a href="#grade-10-books">10th</a></li>
                                    <li class="tab col"><a href="#grade-11-books">11th</a></li>
                                    <li class="tab col"><a href="#grade-12-books">12th</a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- Tab Content -->
                        <div id="unassigned-books" class="grade-content">
                            <h6 class="grey-text">Books not assigned to any grade level</h6>
                            <div id="unassigned-list" class="collection">
                                <!-- Unassigned books will be loaded here -->
                            </div>
                        </div>

                        <div id="kindergarten-books" class="grade-content">
                            <h6 class="grey-text">Kindergarten Books</h6>
                            <div id="kindergarten-list" class="collection">
                                <!-- Kindergarten books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-1-books" class="grade-content">
                            <h6 class="grey-text">1st Grade Books</h6>
                            <div id="grade-1-list" class="collection">
                                <!-- 1st grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-2-books" class="grade-content">
                            <h6 class="grey-text">2nd Grade Books</h6>
                            <div id="grade-2-list" class="collection">
                                <!-- 2nd grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-3-books" class="grade-content">
                            <h6 class="grey-text">3rd Grade Books</h6>
                            <div id="grade-3-list" class="collection">
                                <!-- 3rd grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-4-books" class="grade-content">
                            <h6 class="grey-text">4th Grade Books</h6>
                            <div id="grade-4-list" class="collection">
                                <!-- 4th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-5-books" class="grade-content">
                            <h6 class="grey-text">5th Grade Books</h6>
                            <div id="grade-5-list" class="collection">
                                <!-- 5th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-6-books" class="grade-content">
                            <h6 class="grey-text">6th Grade Books</h6>
                            <div id="grade-6-list" class="collection">
                                <!-- 6th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-7-books" class="grade-content">
                            <h6 class="grey-text">7th Grade Books</h6>
                            <div id="grade-7-list" class="collection">
                                <!-- 7th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-8-books" class="grade-content">
                            <h6 class="grey-text">8th Grade Books</h6>
                            <div id="grade-8-list" class="collection">
                                <!-- 8th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-9-books" class="grade-content">
                            <h6 class="grey-text">9th Grade Books</h6>
                            <div id="grade-9-list" class="collection">
                                <!-- 9th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-10-books" class="grade-content">
                            <h6 class="grey-text">10th Grade Books</h6>
                            <div id="grade-10-list" class="collection">
                                <!-- 10th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-11-books" class="grade-content">
                            <h6 class="grey-text">11th Grade Books</h6>
                            <div id="grade-11-list" class="collection">
                                <!-- 11th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-12-books" class="grade-content">
                            <h6 class="grey-text">12th Grade Books</h6>
                            <div id="grade-12-list" class="collection">
                                <!-- 12th grade books will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col s12">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">history</i>Recent Activity
                        </span>
                        <div id="activity-log">
                            <div class="grey-text">Loading recent activity...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Material Design JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>        // Initialize Materialize components
        document.addEventListener('DOMContentLoaded', function () {
            M.AutoInit();
            
            // Initialize tabs
            var tabsEl = document.querySelectorAll('.tabs');
            M.Tabs.init(tabsEl);
            
            // Initialize select elements
            var selectEl = document.querySelectorAll('select');
            M.FormSelect.init(selectEl);
            
            // Initialize dropdowns (will be called again when books are loaded)
            var dropdownEls = document.querySelectorAll('.dropdown-trigger');
            M.Dropdown.init(dropdownEls, {
                constrainWidth: false,
                coverTrigger: false,
                closeOnClick: true,
                alignment: 'right'
            });
            
            loadISBNs();
            loadActivity();
        });// Load ISBNs        // Add new ISBN or by title/author
        async function addISBN(mode) {
            let title = "";
            let isbn = "";
            let author = "";
            let gradeLevel = "";
            let btn;
            if (mode === 'isbn') {
                title = document.getElementById('new-title-isbn').value.trim();
                isbn = document.getElementById('new-isbn').value.trim();
                gradeLevel = document.getElementById('grade-level-isbn').value;
                btn = document.querySelector("#add-by-isbn button");
                if (!isbn) {
                    M.toast({ html: 'Please enter an ISBN', classes: 'orange' });
                    return;
                }
            } else {
                title = document.getElementById('new-title-title').value.trim();
                author = document.getElementById('new-author').value.trim();
                gradeLevel = document.getElementById('grade-level-title').value;
                btn = document.querySelector("#add-by-title button");
                if (!title) {
                    M.toast({ html: 'Please enter a title', classes: 'orange' });
                    return;
                }
                if (!author) {
                    M.toast({ html: 'Please enter an author', classes: 'orange' });
                    return;
                }
            }
            // Show spinner and disable button
            if (btn) {
                btn.disabled = true;
                btn._originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="material-icons rotating">autorenew</i>Adding...';
            }
            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        isbn: mode === 'isbn' ? isbn : '',
                        author: mode === 'title' ? author : '',
                        grade: gradeLevel
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    // Clear input fields but preserve grade level selection
                    if (mode === 'isbn') {
                        document.getElementById('new-title-isbn').value = '';
                        document.getElementById('new-isbn').value = '';
                        // Don't reset grade level: document.getElementById('grade-level-isbn').value = '';
                    } else {
                        document.getElementById('new-title-title').value = '';
                        document.getElementById('new-author').value = '';
                        // Don't reset grade level: document.getElementById('grade-level-title').value = '';
                    }
                    loadISBNs();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error adding ISBN:', error);
                M.toast({ html: 'Error adding ISBN', classes: 'red' });
            } finally {
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = btn._originalHTML || '<i class="material-icons left">add</i>Add';
                }
            }
        }

        // Remove ISBN
        async function removeISBN(title, isbn) {
            if (!confirm(`Remove ISBN ${isbn} from ${title}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/books/${encodeURIComponent(title)}/${isbn}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadISBNs();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error removing ISBN:', error);
                M.toast({ html: 'Error removing ISBN', classes: 'red' });
            }
        }

        // Scrape specific ISBN
        async function scrapeISBN(isbn) {
            // Find the button for this ISBN and set it to rotating
            const buttons = document.querySelectorAll(`button[onclick*="scrapeISBN('${isbn}')"]`);
            buttons.forEach(btn => {
                const icon = btn.querySelector('i.material-icons');
                if (icon) {
                    icon.classList.add('rotating');
                }
                btn.disabled = true;
            });
            M.toast({ html: `Starting scrape for ${isbn}...`, classes: 'blue' });

            try {
                const response = await fetch(`/api/scrape/${isbn}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadActivity();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error scraping ISBN:', error);
                M.toast({ html: 'Error scraping ISBN', classes: 'red' });
            } finally {
                // Remove rotating and re-enable button
                buttons.forEach(btn => {
                    const icon = btn.querySelector('i.material-icons');
                    if (icon) {
                        icon.classList.remove('rotating');
                    }
                    btn.disabled = false;
                });
            }
        }
        
        // Scrape all ISBNs
        async function scrapeAll() {
            M.toast({ html: 'Starting scrape for all ISBNs...', classes: 'blue' });

            try {
                const response = await fetch('/api/scrape/all', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadActivity();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error scraping all ISBNs:', error);
                M.toast({ html: 'Error scraping all ISBNs', classes: 'red' });
            }
        }        // Load ISBNs organized by grade levels
        async function loadISBNs() {
            const isbnCount = document.getElementById('isbn-count');
            isbnCount.textContent = '0'; // Reset count
            
            // Clear all grade lists
            const gradeContainers = [
                'unassigned-list', 'kindergarten-list', 'grade-1-list', 'grade-2-list',
                'grade-3-list', 'grade-4-list', 'grade-5-list', 'grade-6-list',
                'grade-7-list', 'grade-8-list', 'grade-9-list', 'grade-10-list',
                'grade-11-list', 'grade-12-list'
            ];
            
            gradeContainers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '<div class="grey-text">Loading books...</div>';
                }
            });

            try {
                // Load books and grades data
                const [booksResponse, gradesResponse] = await Promise.all([
                    fetch('/api/books'),
                    fetch('/api/grades')
                ]);
                
                if (!booksResponse.ok || !gradesResponse.ok) {
                    throw new Error('Failed to load data');
                }
                
                const booksData = await booksResponse.json();
                const gradesData = await gradesResponse.json();
                
                isbnCount.textContent = Object.keys(booksData).length.toString();
                
                // Organize books by grade level
                const gradeMapping = {
                    'Kindergarten': 'kindergarten-list',
                    '1st Grade': 'grade-1-list',
                    '2nd Grade': 'grade-2-list',
                    '3rd Grade': 'grade-3-list',
                    '4th Grade': 'grade-4-list',
                    '5th Grade': 'grade-5-list',
                    '6th Grade': 'grade-6-list',
                    '7th Grade': 'grade-7-list',
                    '8th Grade': 'grade-8-list',
                    '9th Grade': 'grade-9-list',
                    '10th Grade': 'grade-10-list',
                    '11th Grade': 'grade-11-list',
                    '12th Grade': 'grade-12-list'
                };
                
                // Create reverse mapping to find which grade a book belongs to
                const bookToGrade = {};
                for (const [gradeName, bookList] of Object.entries(gradesData)) {
                    bookList.forEach(bookTitle => {
                        bookToGrade[bookTitle] = gradeName;
                    });
                }
                
                // Clear all containers
                gradeContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                
                // Organize and display books
                if (booksData && Object.keys(booksData).length > 0) {
                    Object.entries(booksData).forEach(([title, items]) => {
                        const assignedGrade = bookToGrade[title];
                        const containerId = assignedGrade ? gradeMapping[assignedGrade] : 'unassigned-list';
                        const container = document.getElementById(containerId);
                        
                        if (container) {
                            container.innerHTML += generateBookHTML(title, items, assignedGrade);
                        }
                    });
                } else {
                    // Show empty message for unassigned books
                    const unassignedContainer = document.getElementById('unassigned-list');
                    if (unassignedContainer) {
                        unassignedContainer.innerHTML = '<div class="grey-text">No books found</div>';
                    }
                }
                  // Show empty messages for grade levels with no books
                gradeContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container && container.innerHTML === '') {
                        container.innerHTML = '<div class="grey-text">No books assigned to this grade level</div>';
                    }
                });
                  // Reinitialize dropdowns for the newly added content
                var dropdownEls = document.querySelectorAll('.dropdown-trigger');
                M.Dropdown.init(dropdownEls, {
                    constrainWidth: false,
                    coverTrigger: false,
                    closeOnClick: true,
                    alignment: 'right'
                });
                
            } catch (error) {
                console.error('Error loading ISBNs:', error);
                gradeContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '<div class="red-text">Failed to load books. Please check the console for details.</div>';
                    }
                });
            }
        }

        // Generate HTML for a book (single ISBN or group)
        function generateBookHTML(title, items, currentGrade) {
            // Find first icon and author for the group
            let firstIcon = '';
            let firstAuthor = '';
            let isbnCount = items.length;
            
            for (let i = 0; i < items.length; i++) {
                const meta = items[i][Object.keys(items[i])[0]] || {};
                if (!firstIcon && meta.icon_url) firstIcon = meta.icon_url;
                if (!firstAuthor && meta.authors && meta.authors.length) firstAuthor = meta.authors.join(', ');
                if (firstIcon && firstAuthor) break;
            }
            
            const gradeDropdownId = `grade-dropdown-${btoa(title).replace(/[^a-zA-Z0-9]/g, '')}`;
            
            if (isbnCount === 1) {
                // Single ISBN display
                const item = items[0];
                const isbn = Object.keys(item)[0];
                const meta = item[isbn] || {};
                const googleBooksUrl = isbn ? `https://www.google.com/search?tbm=bks&q=isbn:${isbn}` : '#';
                const iconUrl = meta.icon_url || '';
                
                return `
                <div class="isbn-item" data-book-title="${title}">
                    <div class="isbn-info">
                        <div class="book-title">
                            ${iconUrl ? `<img src="${iconUrl}" alt="cover" style="height:32px;width:auto;vertical-align:middle;margin-right:8px;border-radius:3px;box-shadow:0 1px 3px #bbb;">` : `<i class='material-icons' style='vertical-align:middle;margin-right:8px;color:#bdbdbd;'>menu_book</i>`}
                            ${title}
                        </div>
                        <div class="isbn-number">
                            <a href="${googleBooksUrl}" target="_blank" rel="noopener" style="font-weight:bold; color:#1976d2; text-decoration:underline;">${isbn}</a>
                            ${!iconUrl ? `<button class='btn-flat blue-text' style='margin-left:8px;font-size:1em;padding:0 8px;min-width:0;' title='Load Google Books Icon' onclick='loadGoogleBooksIcon("${title.replace(/'/g, "\\'")}", "${isbn}", this)'><i class='material-icons'>image_search</i></button>` : ''}
                        </div>
                        <div class="book-meta">
                            ${meta.authors && meta.authors.length ? 'by ' + meta.authors.join(', ') : ''}
                            ${meta.year ? ' • ' + meta.year : ''}
                        </div>
                    </div>
                    <div class="isbn-actions">
                        <a class='dropdown-trigger btn-flat grey-text' href='#' data-target='${gradeDropdownId}' title='Move to Grade'>
                            <i class='material-icons'>school</i>
                        </a>
                        <ul id='${gradeDropdownId}' class='dropdown-content'>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', null)">Remove from Grades</a></li>
                            <li class="divider"></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', 'Kindergarten')">Kindergarten</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '1st Grade')">1st Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '2nd Grade')">2nd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '3rd Grade')">3rd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '4th Grade')">4th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '5th Grade')">5th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '6th Grade')">6th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '7th Grade')">7th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '8th Grade')">8th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '9th Grade')">9th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '10th Grade')">10th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '11th Grade')">11th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '12th Grade')">12th Grade</a></li>
                        </ul>
                        <button class="btn-flat red-text" onclick="removeISBN('${title.replace(/'/g, "\\'")}', '${isbn}')" title="Remove"><i class="material-icons">delete</i></button>
                        <button class="btn-flat blue-text" onclick="scrapeISBN('${isbn}')" title="Scrape"><i class="material-icons">sync</i></button>
                    </div>
                </div>
                `;
            } else {
                // Multiple ISBNs (group display)
                const groupId = 'group-' + btoa(title).replace(/[^a-zA-Z0-9]/g, '');
                let html = `
                <div class="isbn-group" style="margin-bottom: 18px;" data-book-title="${title}">
                    <div class="isbn-group-header isbn-item" onclick="toggleIsbnGroup('${groupId}', this)" style="cursor:pointer; display:flex; align-items:center; background:#fff; border-radius:8px; box-shadow:0 1px 3px #e0e0e0; padding:15px 10px; border:1px solid #e0e0e0; margin-bottom:0; transition:box-shadow 0.2s;">
                        ${firstIcon ? `<img src="${firstIcon}" alt="cover" style="height:32px;width:auto;vertical-align:middle;margin-right:10px;border-radius:3px;box-shadow:0 1px 3px #bbb;">` : `<i class='material-icons' style='vertical-align:middle;margin-right:10px;color:#bdbdbd;'>menu_book</i>`}
                        <span style="font-size:1.2em;font-weight:500;">${title}</span>
                        <span style="margin-left:10px;color:#666;">${firstAuthor ? 'by ' + firstAuthor : ''}</span>
                        <span class="new badge blue white-text" data-badge-caption="ISBNs" style="margin-left:auto;">${isbnCount}</span>
                        <a class='dropdown-trigger btn-flat grey-text' href='#' data-target='${gradeDropdownId}' title='Move to Grade' onclick="event.stopPropagation();" style="margin-left:10px;">
                            <i class='material-icons'>school</i>
                        </a>
                        <ul id='${gradeDropdownId}' class='dropdown-content'>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', null)">Remove from Grades</a></li>
                            <li class="divider"></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', 'Kindergarten')">Kindergarten</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '1st Grade')">1st Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '2nd Grade')">2nd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '3rd Grade')">3rd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '4th Grade')">4th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '5th Grade')">5th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '6th Grade')">6th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '7th Grade')">7th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '8th Grade')">8th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '9th Grade')">9th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '10th Grade')">10th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '11th Grade')">11th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '12th Grade')">12th Grade</a></li>
                        </ul>
                        <i class="material-icons group-chevron" style="margin-left:10px;transition:transform 0.2s;">expand_more</i>
                    </div>
                    <div class="isbn-group-list" id="${groupId}" style="display:none; background:#fafbfc; border-radius:0 0 8px 8px; border:1px solid #e0e0e0; border-top:none;">
                `;
                
                items.forEach(item => {
                    const isbn = Object.keys(item)[0];
                    const meta = item[isbn] || {};
                    const googleBooksUrl = isbn ? `https://www.google.com/search?tbm=bks&q=isbn:${isbn}` : '#';
                    const iconUrl = meta.icon_url || '';
                    html += `
                    <div class="isbn-item isbn-item-subgroup" style="background:#f0f2f6; max-width:92%; margin-left:5%; border-left:5px solid #667eea; border-radius:6px; box-shadow:0 1px 2px #e0e0e0; padding:13px 10px; margin-bottom:10px; transition:background 0.2s;">
                        <div class="isbn-info">
                            <div class="book-title">
                                ${iconUrl ? `<img src="${iconUrl}" alt="cover" style="height:32px;width:auto;vertical-align:middle;margin-right:8px;border-radius:3px;box-shadow:0 1px 3px #bbb;">` : `<i class='material-icons' style='vertical-align:middle;margin-right:8px;color:#bdbdbd;'>menu_book</i>`}
                                ${title}
                            </div>
                            <div class="isbn-number">
                                <a href="${googleBooksUrl}" target="_blank" rel="noopener" style="font-weight:bold; color:#1976d2; text-decoration:underline;">${isbn}</a>
                                ${!iconUrl ? `<button class='btn-flat blue-text' style='margin-left:8px;font-size:1em;padding:0 8px;min-width:0;' title='Load Google Books Icon' onclick='loadGoogleBooksIcon("${title.replace(/'/g, "\\'")}", "${isbn}", this)'><i class='material-icons'>image_search</i></button>` : ''}
                            </div>
                            <div class="book-meta">
                                ${meta.authors && meta.authors.length ? 'by ' + meta.authors.join(', ') : ''}
                                ${meta.year ? ' • ' + meta.year : ''}
                            </div>
                        </div>
                        <div class="isbn-actions">
                            <button class="btn-flat red-text" onclick="removeISBN('${title.replace(/'/g, "\\'")}', '${isbn}')" title="Remove"><i class="material-icons">delete</i></button>
                            <button class="btn-flat blue-text" onclick="scrapeISBN('${isbn}')" title="Scrape"><i class="material-icons">sync</i></button>
                        </div>
                    </div>
                    `;
                });
                html += `</div></div>`;
                return html;
            }
        }

        // Move book to a specific grade level
        async function moveBookToGrade(bookTitle, grade) {
            try {
                let apiUrl, requestBody, successMessage;
                
                if (grade === null) {
                    // Remove from all grades
                    apiUrl = '/api/grades/remove_all';
                    requestBody = { book: bookTitle };
                    successMessage = `Removed "${bookTitle}" from all grade levels`;
                } else {
                    // Move to specific grade
                    apiUrl = '/api/grades/move';
                    requestBody = { book: bookTitle, grade: grade };
                    successMessage = `Moved "${bookTitle}" to ${grade}`;
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    M.toast({ html: successMessage, classes: 'green' });
                    // Reload books to update the display
                    loadISBNs();
                } else {
                    M.toast({ html: data.error || 'Failed to move book', classes: 'red' });
                }
            } catch (error) {
                console.error('Error moving book to grade:', error);
                M.toast({ html: 'Error moving book to grade', classes: 'red' });
            }
        }

        // Load recent activity
        async function loadActivity() {
            const activityLog = document.getElementById('activity-log');
            
            try {
                const response = await fetch('/api/prices/recent');
                if (response.ok) {
                    const data = await response.json();
                    true;
                    if (data && data.length > 0) {
                        activityLog.innerHTML = data.map(record => {
                            // Handle aN values safely
                            const isbn = record.isbn || 'Unknown ISBN';
                            const source = record.source || 'Unknown Source';
                            const price = (record.price !== null && record.price !== undefined && !isNaN(record.price)) 
                                ? record.price 
                                : null;
                            const timestamp = record.timestamp ? new Date(record.timestamp).toLocaleString() : 'Unknown time';
                            const title = record.title && record.title !== 'NaN' ? ` - ${record.title}` : '';

                            return `
                                <div class="activity-item" style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${isbn}</strong>${title} from ${source}
                                            ${price !== null ? `<span class="green-text"> - $${price}</span>` : '<span class="red-text"> - Failed</span>'}
                                        </div>
                                        <small class="grey-text">${timestamp}</small>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        activityLog.innerHTML = '<div class="grey-text">No recent activity found</div>';
                    }
                } else {
                    // Handle non-200 responses
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    activityLog.innerHTML = '<div class="red-text">Error loading recent activity</div>';
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                activityLog.innerHTML = '<div class="red-text">Failed to load recent activity. Please check the console for details.</div>';
            }
        }        // Enter key support for ISBN input
        document.getElementById('new-isbn').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addISBN();
            }
        });
        document.getElementById('new-title').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addISBN();
            }
        });

        // Load image for specific ISBN
        async function loadImageForISBN(isbn) {
            const imageId = `image-${isbn.replace(/[^a-zA-Z0-9]/g, '')}`;
            const imageElement = document.getElementById(imageId);
            
            if (!imageElement) return;
            
            try {
                const response = await fetch(`/api/images/${isbn}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Find the first available image
                    let imageFound = false;
                    for (const [source, imageInfo] of Object.entries(data.images)) {
                        if (imageInfo.exists) {
                            imageElement.innerHTML = `<img src="${imageInfo.url}" alt="Book cover" class="book-image">`;
                            imageFound = true;
                            break;
                        }
                    }
                    
                    if (!imageFound) {
                        imageElement.innerHTML = 'No Image';
                    }
                } else {
                    imageElement.innerHTML = 'No Image';
                }
            } catch (error) {
                console.error('Error loading image for ISBN:', isbn, error);
                imageElement.innerHTML = 'No Image';
            }
        }

        // Download image for specific ISBN and source
        async function downloadImage(isbn, source) {
            M.toast({ html: `Downloading image for ${isbn} from ${source}...`, classes: 'blue' });
            
            try {
                const response = await fetch(`/api/images/${isbn}/${source}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    // Reload the image for this ISBN
                    loadImageForISBN(isbn);
                } else {
                    M.toast({ html: data.error || 'Failed to download image', classes: 'red' });
                }
            } catch (error) {
                console.error('Error downloading image:', error);
                M.toast({ html: 'Error downloading image', classes: 'red' });
            }
        }

        // Add this function to handle loading the Google Books icon
        async function loadGoogleBooksIcon(title, isbn, btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons">hourglass_top</i>';
            try {
                // Call Google Books API directly to get the icon
                const resp = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.totalItems > 0 && data.items[0].volumeInfo.imageLinks) {
                        const imageLinks = data.items[0].volumeInfo.imageLinks;
                        const iconUrl = imageLinks.thumbnail || imageLinks.smallThumbnail || '';
                        if (iconUrl) {
                            // Update the books.json via API (simulate PATCH by re-adding with icon_url)
                            const patchResp = await fetch('/api/books', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ title: title, isbn: isbn, icon_url: iconUrl, patch_icon: true })
                            });
                            if (patchResp.ok) {
                                M.toast({ html: 'Icon loaded!', classes: 'green' });
                                loadISBNs();
                                return;
                            }
                        }
                    }
                }
                M.toast({ html: 'No icon found for this ISBN', classes: 'orange' });
            } catch (e) {
                M.toast({ html: 'Error loading icon', classes: 'red' });
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="material-icons">image_search</i>';
        }

        // Dropdown toggle function with chevron rotation
        function toggleIsbnGroup(groupId, headerEl) {
            const el = document.getElementById(groupId);
            if (el) {
                const isOpen = el.style.display === 'block';
                el.style.display = isOpen ? 'none' : 'block';
                // Rotate chevron
                if (headerEl) {
                    const chevron = headerEl.querySelector('.group-chevron');
                    if (chevron) {
                        chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
                    }
                }
            }
        }
    </script>
</body>

</html>