<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Price Tracker - Admin</title>

    <!-- Material Design CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <style>
        .admin-card {
            margin: 20px 0;
        }
        .isbn-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 18px;
        }

        .isbn-item:last-child {
            border-bottom: none;
        }

        .isbn-info {
            flex-grow: 1;
            margin-right: 15px;
        }

        .isbn-number {
            margin-bottom: 5px;
        }

        .book-title {
            font-weight: 500;
            color: #1976d2;
            margin-bottom: 3px;
        }

        .book-meta {
            font-size: 0.9em;
            line-height: 1.3;
        }

        .isbn-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #4CAF50;
        }

        .status-error {
            background-color: #f44336;
        }

        .status-pending {
            background-color: #ff9800;
        }

        .isbn-group {
            margin-bottom: 10px;
            /* border: 1px solid #e0e0e0;
            border-radius: 4px; */
            background-color: #fff;
        }

        .isbn-group-header {
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .isbn-group-header:hover {
            background-color: #f5f5f5;
        }

        .isbn-group-list {
            display: none;
            padding: 0 10px 10px;
        }

        .isbn-item-subgroup {
            background: #f0f2f6;
            max-width: 92%;
            margin-left: 5%;
            border-left: 5px solid #667eea;
            border-radius: 6px;
            box-shadow: 0 1px 2px #e0e0e0;
            padding: 13px 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .isbn-item-subgroup:hover {
            background: #e3e6ee !important;
            box-shadow: 0 2px 6px #d0d3db;
        }        /* Rotating animation for sync icon */
        .rotating {
            animation: rotating 1s linear infinite;
        }
        @keyframes rotating {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        /* Grade content styling */
        .grade-content {
            padding-top: 20px;
        }

        .grade-content h6 {
            margin-bottom: 15px;
        }        /* Enhanced responsive tab styling */
        .tabs .tab {
            min-width: 60px;
        }
        
        .tabs .tab a {
            font-size: 12px;
            padding: 0 8px;
            transition: all 0.3s ease;
        }

        /* Desktop enhancements (>= 992px) */
        @media only screen and (min-width: 992px) {
            .tabs {
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                border-radius: 8px;
                overflow: hidden;
            }
            
            .tabs .tab a {
                background-color: #f5f5f5;
                margin: 0 2px;
                border-radius: 6px;
                font-weight: 500;
                transition: all 0.3s ease;
            }
            
            .tabs .tab a:hover {
                background-color: #e0e0e0;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            
            .tabs .tab a.active {
                background-color: #1976d2 !important;
                color: white !important;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
                transform: translateY(-2px);
            }
            
            .tabs .indicator {
                display: none; /* Hide default indicator since we're using custom active styling */
            }
        }

        /* Mobile chip navigation (< 992px) */
        @media only screen and (max-width: 991px) {
            .desktop-tabs {
                display: none !important;
            }
            
            .mobile-grade-chips {
                display: block !important;
                padding: 10px 0;
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            .mobile-grade-chips::-webkit-scrollbar {
                height: 4px;
            }
            
            .mobile-grade-chips::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            
            .mobile-grade-chips::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 2px;
            }
            
            .grade-chip {
                display: inline-block;
                margin: 0 4px;
                padding: 8px 16px;
                background-color: #e0e0e0;
                border: none;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                color: #666;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 60px;
                text-align: center;
                white-space: nowrap;
            }
            
            .grade-chip.active {
                background-color: #1976d2;
                color: white;
                font-weight: 600;
                box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
            }
            
            .grade-chip:hover {
                background-color: #d0d0d0;
            }
            
            .grade-chip.active:hover {
                background-color: #1565c0;
            }
        }

        /* Hide mobile chips by default */
        .mobile-grade-chips {
            display: none;
        }

        /* Fix dropdown clipping issues */
        .dropdown-content {
            z-index: 9999 !important;
            max-height: 300px !important;
            overflow-y: auto !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.25) !important;
        }

        /* Ensure parent containers don't clip dropdowns */
        .collection {
            border: none;
        }
        .card-content,
        .collection,
        .isbn-group,
        .isbn-group-list,
        .grade-content {
            overflow: visible !important;
        }        /* Fix for tab content containers */
        .tabs .tab-content {
            overflow: visible !important;
        }        /* Mobile responsive improvements */
        @media only screen and (max-width: 375px) {
            .container {
                padding: 0 5px;
            }
            
            .admin-card {
                margin: 0.25rem 0;
            }
            
            .card-content {
                padding: 10px;
            }
            
            .tabs .tab a {
                font-size: 8px;
                padding: 0 1px;
            }
            
            .btn, .btn-small {
                font-size: 11px;
                padding: 0 8px;
            }
            
            h4 {
                font-size: 1.6rem;
            }
        }
        
        @media only screen and (max-width: 600px) {
            .container {
                padding: 0 10px;
            }
            
            .admin-card {
                margin: 0.5rem 0;
            }
            
            .card-content {
                padding: 15px;
            }
            
            .isbn-item {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .isbn-item-subgroup {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            .tabs .tab a {
                font-size: 9px;
                padding: 0 2px;
            }
            
            /* Ensure touch targets are at least 48px */
            .btn, .btn-large, .btn-floating, .btn-small {
                min-height: 48px;
                min-width: 48px;
            }
            
            .collapsible-header {
                min-height: 48px;
                padding: 12px 16px;
            }
            
            .isbn-group-header {
                min-height: 48px;
                padding: 12px 10px;
            }
            
            /* Stack form elements vertically on mobile */
            .input-field {
                margin-bottom: 1rem;
            }
            
            /* Reduce font sizes for mobile */
            h4 {
                font-size: 1.8rem;
            }
            
            h5 {
                font-size: 1.5rem;
            }
            
            h6 {
                font-size: 1.2rem;
            }
        }        /* Tablet responsive improvements */
        @media only screen and (min-width: 601px) and (max-width: 992px) {
            .admin-card {
                margin: 0.75rem 0;
            }
            
            .isbn-item {
                padding: 12px;
            }
            
            .tabs .tab a {
                font-size: 10px;
                padding: 0 4px;
            }
            
            .card-content {
                padding: 20px;
            }
        }

        /* Desktop improvements */
        @media only screen and (min-width: 993px) {
            .isbn-item-subgroup:hover {
                background: #e3e6ee !important;
                box-shadow: 0 2px 6px #d0d3db;
            }
            
            .admin-card:hover {
                transform: translateY(-2px);
                transition: all 0.3s ease;
            }
            
            .tabs .tab a {
                font-size: 12px;
                padding: 0 8px;
            }
        }
        
        /* Extra large screens */
        @media only screen and (min-width: 1200px) {
            .container {
                max-width: 1200px;
            }
            
            .admin-card {
                margin: 1rem 0;
            }
            
            .card-content {
                padding: 24px;
            }
        }
    </style>
</head>

<body class="grey lighten-4"></body>    <!-- Navigation -->
    <nav class="blue darken-3">
        <div class="nav-wrapper container">
            <a href="/" class="brand-logo">
                <i class="material-icons left">trending_up</i>Book Price Tracker
            </a>
            <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
                <li><a href="/"><i class="material-icons left">dashboard</i>Dashboard</a></li>
                <li class="active"><a href="/admin"><i class="material-icons left">settings</i>Admin</a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <ul class="sidenav" id="mobile-demo">
        <li><div class="user-view">
            <div class="background">
                <div style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); height: 100%;"></div>
            </div>
            <a href="/"><span class="white-text name">Book Price Tracker</span></a>
        </div></li>
        <li><a href="/"><i class="material-icons">dashboard</i>Dashboard</a></li>
        <li class="active"><a href="/admin"><i class="material-icons">settings</i>Admin</a></li>
    </ul>

    <div class="container">
        <div class="row">
            <div class="col s12">
                <h4 class="blue-text text-darken-3">
                    <i class="material-icons left">settings</i>Administration Panel
                </h4>
                <p class="grey-text">Manage ISBNs and scraping operations</p>
            </div>
        </div>

        <!-- Add ISBN Section -->
        <div class="row">            <div class="col s12 m6">
                <div class="card admin-card hoverable">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">add</i>Add New ISBN
                        </span>
                        <div class="row">
                            <div class="col s12">
                                <ul class="tabs">
                                    <li class="tab col s6"><a class="active" href="#add-by-isbn">ISBN</a></li>
                                    <li class="tab col s6"><a href="#add-by-title">Title</a></li>
                                </ul>
                            </div>                            <div id="add-by-isbn" class="col s12" style="margin-top: 20px;">
                                <div class="input-field">
                                    <input id="new-title-isbn" type="text" required>
                                    <label for="new-title-isbn">Book Title</label>
                                </div>
                                <div class="input-field">
                                    <input id="new-isbn" type="text" required>
                                    <label for="new-isbn">ISBN <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <select id="grade-level-isbn">
                                        <option value="" disabled selected>Select Grade Level (Optional)</option>
                                        <option value="Kindergarten">Kindergarten</option>
                                        <option value="1st Grade">1st Grade</option>
                                        <option value="2nd Grade">2nd Grade</option>
                                        <option value="3rd Grade">3rd Grade</option>
                                        <option value="4th Grade">4th Grade</option>
                                        <option value="5th Grade">5th Grade</option>
                                        <option value="6th Grade">6th Grade</option>
                                        <option value="7th Grade">7th Grade</option>
                                        <option value="8th Grade">8th Grade</option>
                                        <option value="9th Grade">9th Grade</option>
                                        <option value="10th Grade">10th Grade</option>
                                        <option value="11th Grade">11th Grade</option>
                                        <option value="12th Grade">12th Grade</option>
                                    </select>
                                    <label>Grade Level</label>
                                </div>
                                <button class="btn blue waves-effect waves-light" onclick="addISBN('isbn')">
                                    <i class="material-icons left">add</i>Add by ISBN
                                </button>
                            </div>                            <div id="add-by-title" class="col s12" style="margin-top: 20px;">
                                <div class="input-field">
                                    <input id="new-title-title" type="text" required>
                                    <label for="new-title-title">Book Title <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <input id="new-author" type="text" required>
                                    <label for="new-author">Author <span class="red-text">*</span></label>
                                </div>
                                <div class="input-field">
                                    <select id="grade-level-title">
                                        <option value="" disabled selected>Select Grade Level (Optional)</option>
                                        <option value="Kindergarten">Kindergarten</option>
                                        <option value="1st Grade">1st Grade</option>
                                        <option value="2nd Grade">2nd Grade</option>
                                        <option value="3rd Grade">3rd Grade</option>
                                        <option value="4th Grade">4th Grade</option>
                                        <option value="5th Grade">5th Grade</option>
                                        <option value="6th Grade">6th Grade</option>
                                        <option value="7th Grade">7th Grade</option>
                                        <option value="8th Grade">8th Grade</option>
                                        <option value="9th Grade">9th Grade</option>
                                        <option value="10th Grade">10th Grade</option>
                                        <option value="11th Grade">11th Grade</option>
                                        <option value="12th Grade">12th Grade</option>
                                    </select>
                                    <label>Grade Level</label>
                                </div>
                                <button class="btn blue waves-effect waves-light" onclick="addISBN('title')">
                                    <i class="material-icons left">add</i>Add by Title & Author
                                </button>
                                <div class="grey-text" style="margin-top:10px;">Both title and author are required to add by title.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>            <!-- Quick Actions -->
            <div class="col s12 m6">
                <div class="card admin-card hoverable">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">flash_on</i>Quick Actions
                        </span>
                        <p>Perform bulk operations</p>
                    </div>
                    <div class="card-action">
                        <button class="btn green waves-effect waves-light" onclick="scrapeAll()">
                            <i class="material-icons left">sync</i>Scrape All
                        </button>
                        <button class="btn orange waves-effect waves-light" onclick="loadISBNs()">
                            <i class="material-icons left">refresh</i>Refresh List
                        </button>                    </div>
                </div>
            </div>
        </div>        <!-- Book Search Section -->
        <div class="row">
            <div class="col s12">
                <div class="card admin-card hoverable">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">search</i>Search Books
                        </span>
                        <p>Search for books by title, author, or ISBN. If not found, add manually.</p>
                        
                        <div class="row">
                            <div class="input-field col s12 m8">
                                <input id="search-query" type="text" placeholder="Enter title, author, ISBN, or 'Title by Author'">
                                <label for="search-query">Search Query</label>
                            </div>
                            <div class="col s12 m4">
                                <button class="btn blue waves-effect waves-light" onclick="searchBooks()" style="margin-top: 1rem;">
                                    <i class="material-icons left">search</i>Search
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="search-results" style="display: none;">
                            <h6>Search Results</h6>
                            <div id="results-container"></div>
                        </div>
                        
                        <!-- No Results / Manual Entry -->
                        <div id="no-results" style="display: none;">
                            <div class="card-panel orange lighten-4">
                                <div class="row" style="margin-bottom: 0;">
                                    <div class="col s12 m8">
                                        <i class="material-icons left orange-text">info</i>
                                        <span><strong>No results found</strong> for your search. Would you like to add this book manually?</span>
                                    </div>
                                    <div class="col s12 m4">
                                        <button class="btn orange waves-effect waves-light" onclick="openManualEntryFromSearch()">
                                            <i class="material-icons left">add</i>Add Manually
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>        <!-- Grade Level Book Organization -->
        <div class="row">
            <div class="col s12">
                <div class="card admin-card hoverable">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">school</i>Books by Grade Level
                            <span class="badge blue white-text" id="isbn-count">0</span>
                        </span>                          <!-- Grade Level Tabs -->
                        <div class="row">
                            <div class="col s12">
                                <!-- Desktop Tabs -->
                                <ul class="tabs desktop-tabs" id="grade-tabs">
                                    <li class="tab col s2 m1 l1"><a href="#unassigned-books" class="truncate">Unassigned</a></li>
                                    <li class="tab col s1 m1 l1"><a class="active" href="#kindergarten-books">K</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-1-books">1st</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-2-books">2nd</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-3-books">3rd</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-4-books">4th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-5-books">5th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-6-books">6th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-7-books">7th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-8-books">8th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-9-books">9th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-10-books">10th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-11-books">11th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-12-books">12th</a></li>
                                </ul>
                                
                                <!-- Mobile Chip Navigation -->
                                <div class="mobile-grade-chips" id="mobile-grade-chips">
                                    <button class="grade-chip" data-target="unassigned-books">Unassigned</button>
                                    <button class="grade-chip active" data-target="kindergarten-books">K</button>
                                    <button class="grade-chip" data-target="grade-1-books">1st</button>
                                    <button class="grade-chip" data-target="grade-2-books">2nd</button>
                                    <button class="grade-chip" data-target="grade-3-books">3rd</button>
                                    <button class="grade-chip" data-target="grade-4-books">4th</button>
                                    <button class="grade-chip" data-target="grade-5-books">5th</button>
                                    <button class="grade-chip" data-target="grade-6-books">6th</button>
                                    <button class="grade-chip" data-target="grade-7-books">7th</button>
                                    <button class="grade-chip" data-target="grade-8-books">8th</button>
                                    <button class="grade-chip" data-target="grade-9-books">9th</button>
                                    <button class="grade-chip" data-target="grade-10-books">10th</button>
                                    <button class="grade-chip" data-target="grade-11-books">11th</button>
                                    <button class="grade-chip" data-target="grade-12-books">12th</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Content -->
                        <div id="unassigned-books" class="grade-content">
                            <h6 class="grey-text">Books not assigned to any grade level</h6>
                            <div id="unassigned-list" class="collection">
                                <!-- Unassigned books will be loaded here -->
                            </div>
                        </div>

                        <div id="kindergarten-books" class="grade-content">
                            <h6 class="grey-text">Kindergarten Books</h6>
                            <div id="kindergarten-list" class="collection">
                                <!-- Kindergarten books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-1-books" class="grade-content">
                            <h6 class="grey-text">1st Grade Books</h6>
                            <div id="grade-1-list" class="collection">
                                <!-- 1st grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-2-books" class="grade-content">
                            <h6 class="grey-text">2nd Grade Books</h6>
                            <div id="grade-2-list" class="collection">
                                <!-- 2nd grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-3-books" class="grade-content">
                            <h6 class="grey-text">3rd Grade Books</h6>
                            <div id="grade-3-list" class="collection">
                                <!-- 3rd grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-4-books" class="grade-content">
                            <h6 class="grey-text">4th Grade Books</h6>
                            <div id="grade-4-list" class="collection">
                                <!-- 4th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-5-books" class="grade-content">
                            <h6 class="grey-text">5th Grade Books</h6>
                            <div id="grade-5-list" class="collection">
                                <!-- 5th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-6-books" class="grade-content">
                            <h6 class="grey-text">6th Grade Books</h6>
                            <div id="grade-6-list" class="collection">
                                <!-- 6th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-7-books" class="grade-content">
                            <h6 class="grey-text">7th Grade Books</h6>
                            <div id="grade-7-list" class="collection">
                                <!-- 7th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-8-books" class="grade-content">
                            <h6 class="grey-text">8th Grade Books</h6>
                            <div id="grade-8-list" class="collection">
                                <!-- 8th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-9-books" class="grade-content">
                            <h6 class="grey-text">9th Grade Books</h6>
                            <div id="grade-9-list" class="collection">
                                <!-- 9th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-10-books" class="grade-content">
                            <h6 class="grey-text">10th Grade Books</h6>
                            <div id="grade-10-list" class="collection">
                                <!-- 10th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-11-books" class="grade-content">
                            <h6 class="grey-text">11th Grade Books</h6>
                            <div id="grade-11-list" class="collection">
                                <!-- 11th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-12-books" class="grade-content">
                            <h6 class="grey-text">12th Grade Books</h6>
                            <div id="grade-12-list" class="collection">
                                <!-- 12th grade books will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col s12">
                <div class="card admin-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">history</i>Recent Activity
                        </span>
                        <div id="activity-log">
                            <div class="grey-text">Loading recent activity...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download all icons button -->
        <div class="fixed-action-btn" style="bottom: 110px; right: 24px;">
            <button id="download-all-icons-btn" class="btn-floating btn-large orange darken-1" onclick="downloadAllIcons()">
                <i class="large material-icons">image</i>
            </button>
            <span class="btn-floating mobile-fab-tip">Download All Icons</span>
        </div>
    </div>

    <!-- Material Design JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>        
        // Global variables
        let currentSearchQuery = '';
        var editIsbnContext = { title: '', isbn: '' };
        
        // Initialize Materialize components
        document.addEventListener('DOMContentLoaded', function () {
            M.AutoInit();
              // Initialize tabs
            var tabsEl = document.querySelectorAll('.tabs');
            M.Tabs.init(tabsEl);
            
            // Initialize mobile grade chip navigation
            initializeMobileGradeChips();
            
            // Initialize select elements
            var selectEl = document.querySelectorAll('select');
            M.FormSelect.init(selectEl);
            
            // Initialize dropdowns (will be called again when books are loaded)
            var dropdownEls = document.querySelectorAll('.dropdown-trigger');
            M.Dropdown.init(dropdownEls, {
                constrainWidth: false,
                coverTrigger: false,
                closeOnClick: true,
                alignment: 'right'
            });
            
            loadISBNs();
            loadActivity();
        });// Load ISBNs        // Add new ISBN or by title/author
        async function addISBN(mode) {
            let title = "";
            let isbn = "";
            let author = "";
            let gradeLevel = "";
            let btn;
            if (mode === 'isbn') {
                title = document.getElementById('new-title-isbn').value.trim();
                isbn = document.getElementById('new-isbn').value.trim();
                gradeLevel = document.getElementById('grade-level-isbn').value;
                btn = document.querySelector("#add-by-isbn button");
                if (!isbn) {
                    M.toast({ html: 'Please enter an ISBN', classes: 'orange' });
                    return;
                }
            } else {
                title = document.getElementById('new-title-title').value.trim();
                author = document.getElementById('new-author').value.trim();
                gradeLevel = document.getElementById('grade-level-title').value;
                btn = document.querySelector("#add-by-title button");
                if (!title) {
                    M.toast({ html: 'Please enter a title', classes: 'orange' });
                    return;
                }
                if (!author) {
                    M.toast({ html: 'Please enter an author', classes: 'orange' });
                    return;
                }
            }
            // Show spinner and disable button
            if (btn) {
                btn.disabled = true;
                btn._originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="material-icons rotating">autorenew</i>Adding...';
            }
            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        isbn: mode === 'isbn' ? isbn : '',
                        author: mode === 'title' ? author : '',
                        grade: gradeLevel
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    // The backend message now includes the book title and related ISBNs as needed
                    M.toast({ html: data.message, classes: 'green' });
                    // Clear input fields but preserve grade level selection
                    if (mode === 'isbn') {
                        document.getElementById('new-title-isbn').value = '';
                        document.getElementById('new-isbn').value = '';
                        // Don't reset grade level: document.getElementById('grade-level-isbn').value = '';
                    } else {                        document.getElementById('new-title-title').value = '';
                        document.getElementById('new-author').value = '';
                        // Don't reset grade level: document.getElementById('grade-level-title').value = '';
                    }
                    loadISBNs();
                } else {
                    // Check if we should show the manual entry form
                    if (data.show_manual_form && data.prefill_data) {
                        // Show toast with error message first
                        M.toast({ html: data.error, classes: 'orange' });
                        
                        // Open manual entry modal and pre-fill with user's input
                        openManualEntryWithPrefill(data.prefill_data);
                    } else {
                        M.toast({ html: data.error, classes: 'red' });
                    }
                }
            } catch (error) {
                console.error('Error adding ISBN:', error);
                M.toast({ html: 'Error adding ISBN', classes: 'red' });
            } finally {
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = btn._originalHTML || '<i class="material-icons left">add</i>Add';
                }
            }
        }

        // Remove ISBN
        async function removeISBN(title, isbn) {
            if (!confirm(`Remove ISBN ${isbn} from ${title}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/books/${encodeURIComponent(title)}/${isbn}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadISBNs();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error removing ISBN:', error);
                M.toast({ html: 'Error removing ISBN', classes: 'red' });
            }
        }

        // Scrape specific ISBN
        async function scrapeISBN(isbn) {
            // Find the button for this ISBN and set it to rotating
            const buttons = document.querySelectorAll(`button[onclick*="scrapeISBN('${isbn}')"]`);
            buttons.forEach(btn => {
                const icon = btn.querySelector('i.material-icons');
                if (icon) {
                    icon.classList.add('rotating');
                }
                btn.disabled = true;
            });
            M.toast({ html: `Starting scrape for ${isbn}...`, classes: 'blue' });

            try {
                const response = await fetch(`/api/scrape/${isbn}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadActivity();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error scraping ISBN:', error);
                M.toast({ html: 'Error scraping ISBN', classes: 'red' });
            } finally {
                // Remove rotating and re-enable button
                buttons.forEach(btn => {
                    const icon = btn.querySelector('i.material-icons');
                    if (icon) {
                        icon.classList.remove('rotating');
                    }
                    btn.disabled = false;
                });
            }
        }
        
        // Scrape all ISBNs
        async function scrapeAll() {
            M.toast({ html: 'Starting scrape for all ISBNs...', classes: 'blue' });

            try {
                const response = await fetch('/api/scrape/all', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadActivity();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error scraping all ISBNs:', error);
                M.toast({ html: 'Error scraping all ISBNs', classes: 'red' });
            }
        }        // Load ISBNs organized by grade levels
        async function loadISBNs() {
            const isbnCount = document.getElementById('isbn-count');
            isbnCount.textContent = '0'; // Reset count
            
            // Clear all grade lists
            const gradeContainers = [
                'unassigned-list', 'kindergarten-list', 'grade-1-list', 'grade-2-list',
                'grade-3-list', 'grade-4-list', 'grade-5-list', 'grade-6-list',
                'grade-7-list', 'grade-8-list', 'grade-9-list', 'grade-10-list',
                'grade-11-list', 'grade-12-list'
            ];
            
            gradeContainers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '<div class="grey-text">Loading books...</div>';
                }
            });

            try {
                // Load books and grades data
                const [booksResponse, gradesResponse] = await Promise.all([
                    fetch('/api/books'),
                    fetch('/api/grades')
                ]);
                
                if (!booksResponse.ok || !gradesResponse.ok) {
                    throw new Error('Failed to load data');
                }
                
                const booksData = await booksResponse.json();
                const gradesData = await gradesResponse.json();
                
                isbnCount.textContent = Object.keys(booksData).length.toString();
                
                // Organize books by grade level
                const gradeMapping = {
                    'Kindergarten': 'kindergarten-list',
                    '1st Grade': 'grade-1-list',
                    '2nd Grade': 'grade-2-list',
                    '3rd Grade': 'grade-3-list',
                    '4th Grade': 'grade-4-list',
                    '5th Grade': 'grade-5-list',
                    '6th Grade': 'grade-6-list',
                    '7th Grade': 'grade-7-list',
                    '8th Grade': 'grade-8-list',
                    '9th Grade': 'grade-9-list',
                    '10th Grade': 'grade-10-list',
                    '11th Grade': 'grade-11-list',
                    '12th Grade': 'grade-12-list'
                };
                
                // Create reverse mapping to find which grade a book belongs to
                const bookToGrade = {};
                for (const [gradeName, bookList] of Object.entries(gradesData)) {
                    bookList.forEach(bookTitle => {
                        bookToGrade[bookTitle] = gradeName;
                    });
                }
                
                // Clear all containers
                gradeContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                
                // Organize and display books
                if (booksData && Object.keys(booksData).length > 0) {
                    Object.entries(booksData).forEach(([title, items]) => {
                        const assignedGrade = bookToGrade[title];
                        const containerId = assignedGrade ? gradeMapping[assignedGrade] : 'unassigned-list';
                        const container = document.getElementById(containerId);
                        
                        if (container) {
                            container.innerHTML += generateBookHTML(title, items, assignedGrade);
                        }
                    });
                } else {
                    // Show empty message for unassigned books
                    const unassignedContainer = document.getElementById('unassigned-list');
                    if (unassignedContainer) {
                        unassignedContainer.innerHTML = '<div class="grey-text">No books found</div>';
                    }
                }
                  // Show empty messages for grade levels with no books
                gradeContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container && container.innerHTML === '') {
                        container.innerHTML = '<div class="grey-text">No books assigned to this grade level</div>';
                    }
                });
                  // Reinitialize dropdowns for the newly added content
                var dropdownEls = document.querySelectorAll('.dropdown-trigger');
                M.Dropdown.init(dropdownEls, {
                    constrainWidth: false,
                    coverTrigger: false,
                    closeOnClick: true,
                    alignment: 'right'
                });
                
            } catch (error) {
                console.error('Error loading ISBNs:', error);
                gradeContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '<div class="red-text">Failed to load books. Please check the console for details.</div>';
                    }
                });
            }
        }

        // Generate HTML for a book (single ISBN or group)
        function generateBookHTML(title, items, currentGrade) {
            // Find first icon and author for the group
            let firstIcon = '';
            let firstAuthor = '';
            let isbnCount = items.length;
            
            for (let i = 0; i < items.length; i++) {
                const meta = items[i][Object.keys(items[i])[0]] || {};
                if (!firstIcon && meta.icon_url) firstIcon = meta.icon_url;
                if (!firstAuthor && meta.authors && meta.authors.length) firstAuthor = meta.authors.join(', ');
                if (firstIcon && firstAuthor) break;
            }
            
            const gradeDropdownId = `grade-dropdown-${btoa(title).replace(/[^a-zA-Z0-9]/g, '')}`;
            
            if (isbnCount === 1) {
                // Single ISBN display
                const item = items[0];
                const isbn = Object.keys(item)[0];
                const meta = item[isbn] || {};
                const googleBooksUrl = isbn ? `https://www.google.com/search?tbm=bks&q=isbn:${isbn}` : '#';
                const iconUrl = meta.icon_url || '';
                
                return `
                <div class="isbn-item" data-book-title="${title}">
                    <div class="isbn-info">
                        <div class="book-title">
                            ${iconUrl ? `<img src="${iconUrl}" alt="cover" style="height:32px;width:auto;vertical-align:middle;margin-right:8px;border-radius:3px;box-shadow:0 1px 3px #bbb;">` : `<i class='material-icons' style='vertical-align:middle;margin-right:8px;color:#bdbdbd;'>menu_book</i>`}
                            ${title}
                        </div>
                        <div class="isbn-number">
                            <a href="${googleBooksUrl}" target="_blank" rel="noopener" style="font-weight:bold; color:#1976d2; text-decoration:underline;">${isbn}</a>
                            ${!iconUrl ? `<button class='btn-flat blue-text' style='margin-left:8px;font-size:1em;padding:0 8px;min-width:0;' title='Load Google Books Icon' onclick='loadGoogleBooksIcon("${title.replace(/'/g, "\\'")}", "${isbn}", this)'><i class='material-icons'>image_search</i></button>` : ''}
                        </div>
                        <div class="book-meta">
                            ${meta.authors && meta.authors.length ? 'by ' + meta.authors.join(', ') : ''}
                            ${meta.year ? ' â€¢ ' + meta.year : ''}
                        </div>
                    </div>
                    <div class="isbn-actions">
                        <a class='dropdown-trigger btn-flat grey-text' href='#' data-target='${gradeDropdownId}' title='Move to Grade'>
                            <i class='material-icons'>school</i>
                        </a>
                        <ul id='${gradeDropdownId}' class='dropdown-content'>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', null)">Remove from Grades</a></li>
                            <li class="divider"></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', 'Kindergarten')">Kindergarten</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '1st Grade')">1st Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '2nd Grade')">2nd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '3rd Grade')">3rd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '4th Grade')">4th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '5th Grade')">5th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '6th Grade')">6th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '7th Grade')">7th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '8th Grade')">8th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '9th Grade')">9th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '10th Grade')">10th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '11th Grade')">11th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '12th Grade')">12th Grade</a></li>
                        </ul>
                        <button class="btn-flat blue-text" onclick="openEditIsbnModal('${title.replace(/'/g, "\\'")}', '${isbn}', decodeURIComponent('${encodeURIComponent(JSON.stringify(meta))}'))" title="Edit"><i class="material-icons">edit</i></button>
                        <button class="btn-flat red-text" onclick="removeISBN('${title.replace(/'/g, "\\'")}', '${isbn}')" title="Remove"><i class="material-icons">delete</i></button>
                        <button class="btn-flat blue-text" onclick="scrapeISBN('${isbn}')" title="Scrape"><i class="material-icons">sync</i></button>
                    </div>
                </div>
                `;
            } else {
                // Multiple ISBNs (group display)
                const groupId = 'group-' + btoa(title).replace(/[^a-zA-Z0-9]/g, '');
                let html = `
                <div class="isbn-group" style="margin-bottom: 18px;" data-book-title="${title}">
                    <div class="isbn-group-header isbn-item" onclick="toggleIsbnGroup('${groupId}', this)" style="cursor:pointer; display:flex; align-items:center; background:#fff; border-radius:8px; box-shadow:0 1px 3px #e0e0e0; padding:15px 10px; border:1px solid #e0e0e0; margin-bottom:0; transition:box-shadow 0.2s;">
                        ${firstIcon ? `<img src="${firstIcon}" alt="cover" style="height:32px;width:auto;vertical-align:middle;margin-right:10px;border-radius:3px;box-shadow:0 1px 3px #bbb;">` : `<i class='material-icons' style='vertical-align:middle;margin-right:10px;color:#bdbdbd;'>menu_book</i>`}
                        <span style="font-size:1.2em;font-weight:500;">${title}</span>
                        <span style="margin-left:10px;color:#666;">${firstAuthor ? 'by ' + firstAuthor : ''}</span>
                        <span class="new badge blue white-text" data-badge-caption="ISBNs" style="margin-left:auto;">${isbnCount}</span>
                        <a class='dropdown-trigger btn-flat grey-text' href='#' data-target='${gradeDropdownId}' title='Move to Grade' onclick="event.stopPropagation();" style="margin-left:10px;">
                            <i class='material-icons'>school</i>
                        </a>
                        <ul id='${gradeDropdownId}' class='dropdown-content'>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', null)">Remove from Grades</a></li>
                            <li class="divider"></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', 'Kindergarten')">Kindergarten</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '1st Grade')">1st Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '2nd Grade')">2nd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '3rd Grade')">3rd Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '4th Grade')">4th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '5th Grade')">5th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '6th Grade')">6th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '7th Grade')">7th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '8th Grade')">8th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '9th Grade')">9th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '10th Grade')">10th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '11th Grade')">11th Grade</a></li>
                            <li><a href="#!" onclick="moveBookToGrade('${title.replace(/'/g, "\\'")}', '12th Grade')">12th Grade</a></li>
                        </ul>
                        <i class="material-icons group-chevron" style="margin-left:10px;transition:transform 0.2s;">expand_more</i>
                    </div>
                    <div class="isbn-group-list" id="${groupId}" style="display:none; background:#fafbfc; border-radius:0 0 8px 8px; border:1px solid #e0e0e0; border-top:none;">
                `;
                
                items.forEach(item => {
                    const isbn = Object.keys(item)[0];
                    const meta = item[isbn] || {};
                    const googleBooksUrl = isbn ? `https://www.google.com/search?tbm=bks&q=isbn:${isbn}` : '#';
                    const iconUrl = meta.icon_url || '';
                    html += `
                    <div class="isbn-item isbn-item-subgroup" style="background:#f0f2f6; max-width:92%; margin-left:5%; border-left:5px solid #667eea; border-radius:6px; box-shadow:0 1px 2px #e0e0e0; padding:13px 10px; margin-bottom:10px; transition:background 0.2s;">
                        <div class="isbn-info">
                            <div class="book-title">
                                ${iconUrl ? `<img src="${iconUrl}" alt="cover" style="height:32px;width:auto;vertical-align:middle;margin-right:8px;border-radius:3px;box-shadow:0 1px 3px #bbb;">` : `<i class='material-icons' style='vertical-align:middle;margin-right:8px;color:#bdbdbd;'>menu_book</i>`}
                                ${title}
                            </div>
                            <div class="isbn-number">
                                <a href="${googleBooksUrl}" target="_blank" rel="noopener" style="font-weight:bold; color:#1976d2; text-decoration:underline;">${isbn}</a>
                                ${!iconUrl ? `<button class='btn-flat blue-text' style='margin-left:8px;font-size:1em;padding:0 8px;min-width:0;' title='Load Google Books Icon' onclick='loadGoogleBooksIcon("${title.replace(/'/g, "\\'")}", "${isbn}", this)'><i class='material-icons'>image_search</i></button>` : ''}
                            </div>
                            <div class="book-meta">
                                ${meta.authors && meta.authors.length ? 'by ' + meta.authors.join(', ') : ''}
                                ${meta.year ? ' â€¢ ' + meta.year : ''}
                            </div>
                        </div>
                        <div class="isbn-actions">
                            <button class="btn-flat blue-text" onclick="openEditIsbnModal('${title.replace(/'/g, "\\'")}', '${isbn}', decodeURIComponent('${encodeURIComponent(JSON.stringify(meta))}'))" title="Edit"><i class="material-icons">edit</i></button>
                            <button class="btn-flat red-text" onclick="removeISBN('${title.replace(/'/g, "\\'")}', '${isbn}')" title="Remove"><i class="material-icons">delete</i></button>
                            <button class="btn-flat blue-text" onclick="scrapeISBN('${isbn}')" title="Scrape"><i class="material-icons">sync</i></button>
                        </div>
                    </div>
                    `;
                });
                html += `</div></div>`;
                return html;
            }
        }

        // Move book to a specific grade level
        async function moveBookToGrade(bookTitle, grade) {
            try {
                let apiUrl, requestBody, successMessage;
                
                if (grade === null) {
                    // Remove from all grades
                    apiUrl = '/api/grades/remove_all';
                    requestBody = { book: bookTitle };
                    successMessage = `Removed "${bookTitle}" from all grade levels`;
                } else {
                    // Move to specific grade
                    apiUrl = '/api/grades/move';
                    requestBody = { book: bookTitle, grade: grade };
                    successMessage = `Moved "${bookTitle}" to ${grade}`;
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    M.toast({ html: successMessage, classes: 'green' });
                    // Reload books to update the display
                    loadISBNs();
                } else {
                    M.toast({ html: data.error || 'Failed to move book', classes: 'red' });
                }
            } catch (error) {
                console.error('Error moving book to grade:', error);
                M.toast({ html: 'Error moving book to grade', classes: 'red' });
            }
        }

        // Load recent activity
        async function loadActivity() {
            const activityLog = document.getElementById('activity-log');
            
            try {
                const response = await fetch('/api/prices/recent');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        activityLog.innerHTML = data.map(record => {
                            // Handle aN values safely
                            const isbn = record.isbn || 'Unknown ISBN';
                            const source = record.source || 'Unknown Source';
                            const price = (record.price !== null && record.price !== undefined && !isNaN(record.price)) 
                                ? record.price 
                                : null;
                            const timestamp = record.timestamp ? new Date(record.timestamp).toLocaleString() : 'Unknown time';
                            const title = record.title && record.title !== 'NaN' ? ` - ${record.title}` : '';

                            return `
                                <div class="activity-item" style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${isbn}</strong>${title} from ${source}
                                            ${price !== null ? `<span class="green-text"> - $${price}</span>` : '<span class="red-text"> - Failed</span>'}
                                        </div>
                                        <small class="grey-text">${timestamp}</small>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        activityLog.innerHTML = '<div class="grey-text">No recent activity found</div>';
                    }
                } else {
                    // Handle non-200 responses
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    activityLog.innerHTML = '<div class="red-text">Error loading recent activity</div>';
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                activityLog.innerHTML = '<div class="red-text">Failed to load recent activity. Please check the console for details.</div>';
            }
        }        // Enter key support for ISBN input
        document.getElementById('new-isbn').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addISBN();
            }
        });
        document.getElementById('new-title').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addISBN();
            }
        });

        // Load image for specific ISBN
        async function loadImageForISBN(isbn) {
            const imageId = `image-${isbn.replace(/[^a-zA-Z0-9]/g, '')}`;
            const imageElement = document.getElementById(imageId);
            
            if (!imageElement) return;
            
            try {
                const response = await fetch(`/api/images/${isbn}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Find the first available image
                    let imageFound = false;
                    for (const [source, imageInfo] of Object.entries(data.images)) {
                        if (imageInfo.exists) {
                            imageElement.innerHTML = `<img src="${imageInfo.url}" alt="Book cover" class="book-image">`;
                            imageFound = true;
                            break;
                        }
                    }
                    
                    if (!imageFound) {
                        imageElement.innerHTML = 'No Image';
                    }
                } else {
                    imageElement.innerHTML = 'No Image';
                }
            } catch (error) {
                console.error('Error loading image for ISBN:', isbn, error);
                imageElement.innerHTML = 'No Image';
            }
        }

        // Download image for specific ISBN and source
        async function downloadImage(isbn, source) {
            M.toast({ html: `Downloading image for ${isbn} from ${source}...`, classes: 'blue' });
            
            try {
                const response = await fetch(`/api/images/${isbn}/${source}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    // Reload the image for this ISBN
                    loadImageForISBN(isbn);
                } else {
                    M.toast({ html: data.error || 'Failed to download image', classes: 'red' });
                }
            } catch (error) {
                console.error('Error downloading image:', error);
                M.toast({ html: 'Error downloading image', classes: 'red' });
            }
        }

        // Add this function to handle loading the Google Books icon
        async function loadGoogleBooksIcon(title, isbn, btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons">hourglass_top</i>';
            try {
                // Call Google Books API directly to get the icon
                const resp = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);                if (resp.ok) {
                    const data = await resp.json();
                    if (data.totalItems > 0 && data.items[0].volumeInfo.imageLinks) {
                        const imageLinks = data.items[0].volumeInfo.imageLinks;
                        const iconUrl = imageLinks.thumbnail || imageLinks.smallThumbnail || '';
                        if (iconUrl) {
                            // Update the books.json via API (simulate PATCH by re-adding with icon_url)
                            const patchResp = await fetch('/api/books', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ title: title, isbn: isbn, icon_url: iconUrl, patch_icon: true })
                            });
                            if (patchResp.ok) {
                                // Download the icon locally
                                try {
                                    const downloadResp = await fetch(`/api/images/${isbn}/googlebooks`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ url: iconUrl })
                                    });
                                    if (downloadResp.ok) {
                                        M.toast({ html: 'Icon loaded and saved locally!', classes: 'green' });
                                    } else {
                                        M.toast({ html: 'Icon loaded but not saved locally', classes: 'orange' });
                                    }
                                } catch (e) {
                                    console.error('Error saving icon locally:', e);
                                }
                                loadISBNs();
                                return;
                            }
                        }
                    }
                }
                M.toast({ html: 'No icon found for this ISBN', classes: 'orange' });
            } catch (e) {
                M.toast({ html: 'Error loading icon', classes: 'red' });
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="material-icons">image_search</i>';
        }

        // Dropdown toggle function with chevron rotation
        function toggleIsbnGroup(groupId, headerEl) {
            const el = document.getElementById(groupId);
            if (el) {
                const isOpen = el.style.display === 'block';
                el.style.display = isOpen ? 'none' : 'block';
                // Rotate chevron
                if (headerEl) {
                    const chevron = headerEl.querySelector('.group-chevron');
                    if (chevron) {
                        chevron.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
                    }
                }
            }
        }

        // Add ISBN input field for manual entry
        function addISBNInput() {
            const isbnInputsContainer = document.getElementById('isbn-inputs');
            const newInputRow = document.createElement('div');
            newInputRow.className = 'input-field isbn-input-row';
            newInputRow.style = 'display: flex; align-items: center; margin-bottom: 10px;';
            newInputRow.innerHTML = `
                <input type="text" class="isbn-input validate" placeholder="Enter ISBN (10 or 13 digits)" required>
                <button type="button" class="btn-flat red-text remove-isbn-btn" style="margin-left: 10px; display: none;">
                    <i class="material-icons">remove</i>
                </button>
            `;
            
            // Show remove button on input focus
            newInputRow.querySelector('input').addEventListener('focus', function () {
                newInputRow.querySelector('.remove-isbn-btn').style.display = 'inline-block';
            });
            
            // Hide remove button when input is empty
            newInputRow.querySelector('input').addEventListener('input', function () {
                if (!this.value.trim()) {
                    newInputRow.querySelector('.remove-isbn-btn').style.display = 'none';
                } else {
                    newInputRow.querySelector('.remove-isbn-btn').style.display = 'inline-block';
                }
            });
            
            // Remove input row on button click
            newInputRow.querySelector('.remove-isbn-btn').addEventListener('click', function () {
                isbnInputsContainer.removeChild(newInputRow);
            });
            
            isbnInputsContainer.appendChild(newInputRow);
            M.updateTextFields();
        }

        // Submit manual book entry
        async function submitManualEntry() {
            const title = document.getElementById('manual-title').value.trim();
            const authors = document.getElementById('manual-authors').value.trim();
            const isbnElements = document.querySelectorAll('.isbn-input');
            const isbns = Array.from(isbnElements).map(el => el.value.trim()).filter(Boolean);
            const publisher = document.getElementById('manual-publisher').value.trim();
            const year = document.getElementById('manual-year').value.trim();
            const iconUrl = document.getElementById('manual-icon-url').value.trim();
            const gradeLevel = document.getElementById('manual-grade').value;
            const btn = document.querySelector("#manual-entry-modal .btn.blue");

            if (!title) {
                M.toast({ html: 'Please enter a book title', classes: 'orange' });
                return;
            }
            if (isbns.length === 0) {
                M.toast({ html: 'Please enter at least one ISBN', classes: 'orange' });
                return;
            }

            // Show spinner and disable button
            if (btn) {
                btn.disabled = true;
                btn._originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="material-icons rotating">autorenew</i>Adding...';
            }

            try {
                const response = await fetch('/api/books/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        authors: authors.split(',').map(a => a.trim()),
                        isbns: isbns,
                        publisher: publisher,
                        year: year,
                        icon_url: iconUrl,
                        grade: gradeLevel
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    M.toast({ html: 'Book added successfully!', classes: 'green' });
                    // Close the modal
                    const modal = M.Modal.getInstance(document.getElementById('manual-entry-modal'));
                    modal.close();
                    // Reset the form
                    document.getElementById('manual-title').value = '';
                    document.getElementById('manual-authors').value = '';
                    document.getElementById('manual-publisher').value = '';
                    document.getElementById('manual-year').value = '';
                    document.getElementById('manual-icon-url').value = '';
                    document.getElementById('manual-grade').selectedIndex = 0;
                    // Clear ISBN inputs
                    document.getElementById('isbn-inputs').innerHTML = '';
                    addISBNInput(); // Add one empty input by default
                    loadISBNs();
                } else {
                    M.toast({ html: data.error, classes: 'red' });
                }
            } catch (error) {
                console.error('Error adding book manually:', error);
                M.toast({ html: 'Error adding book manually', classes: 'red' });
            } finally {
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = btn._originalHTML || '<i class="material-icons left">save</i>Add Book';
                }            }
        }        // Book Search Functions
        
        // Search for books
        async function searchBooks() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                M.toast({ html: 'Please enter a search query', classes: 'orange' });
                return;
            }
            
            currentSearchQuery = query;
            
            try {
                // Show loading
                document.getElementById('search-results').style.display = 'none';
                document.getElementById('no-results').style.display = 'none';
                
                const response = await fetch('/api/books/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        type: 'auto'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.search_successful && data.results.length > 0) {
                        displaySearchResults(data.results);
                    } else {
                        showNoResults();
                    }
                } else {
                    M.toast({ html: data.error || 'Search failed', classes: 'red' });
                }
            } catch (error) {
                console.error('Error searching books:', error);
                M.toast({ html: 'Error searching books', classes: 'red' });
            }
        }
        
        // Display search results
        function displaySearchResults(results) {
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            
            results.forEach((book, index) => {
                const authorsText = book.authors && book.authors.length > 0 ? 
                    book.authors.join(', ') : 'Unknown Author';
                
                const card = document.createElement('div');
                card.className = 'card-panel';
                card.innerHTML = `
                    <div class="row" style="margin-bottom: 0;">
                        <div class="col s12 m8">
                            <h6 style="margin: 0 0 0.5rem 0;">${book.title}</h6>
                            <p style="margin: 0; color: #666;">
                                <strong>Authors:</strong> ${authorsText}<br>
                                ${book.publisher ? `<strong>Publisher:</strong> ${book.publisher}<br>` : ''}
                                ${book.year ? `<strong>Year:</strong> ${book.year}<br>` : ''}
                                ${book.isbn13 ? `<strong>ISBN-13:</strong> ${book.isbn13}<br>` : ''}
                                ${book.isbn10 ? `<strong>ISBN-10:</strong> ${book.isbn10}` : ''}
                            </p>
                        </div>
                        <div class="col s12 m4">
                            <button class="btn green waves-effect waves-light" 
                                    onclick="addBookFromSearch(${index})" 
                                    style="width: 100%;">
                                <i class="material-icons left">add</i>Add This Book
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            document.getElementById('search-results').style.display = 'block';
            
            // Store results for later use
            window.searchResults = results;
        }
        
        // Show no results message
        function showNoResults() {
            document.getElementById('no-results').style.display = 'block';
        }
        
        // Add book from search results
        async function addBookFromSearch(index) {
            const book = window.searchResults[index];
            if (!book) return;
            
            try {
                const isbn = book.isbn13 || book.isbn10;
                if (!isbn) {
                    M.toast({ html: 'No ISBN available for this book', classes: 'orange' });
                    return;
                }
                
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: book.title,
                        isbn: isbn,
                        grade: '' // Could add grade selection later
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    M.toast({ html: data.message, classes: 'green' });
                    loadISBNs(); // Refresh the list
                    // Clear search
                    document.getElementById('search-query').value = '';
                    document.getElementById('search-results').style.display = 'none';
                    document.getElementById('no-results').style.display = 'none';
                } else {
                    M.toast({ html: data.error || 'Failed to add book', classes: 'red' });
                }
            } catch (error) {
                console.error('Error adding book:', error);
                M.toast({ html: 'Error adding book', classes: 'red' });
            }
        }
        
        // Open manual entry modal with search query pre-filled
        function openManualEntryFromSearch() {
            // Pre-fill the manual entry form with search query
            const modal = M.Modal.getInstance(document.getElementById('manual-entry-modal'));
            
            // Try to parse the search query
            const query = currentSearchQuery;
            if (query.includes(' by ')) {
                const parts = query.split(' by ');
                if (parts.length === 2) {
                    document.getElementById('manual-title').value = parts[0].trim();
                    document.getElementById('manual-authors').value = parts[1].trim();
                }
            } else {
                // Assume it's a title
                document.getElementById('manual-title').value = query;
            }
            
            // Update labels
            M.updateTextFields();
            
            modal.open();
        }
          // Open manual entry modal with prefill data from failed search
        function openManualEntryWithPrefill(prefillData) {
            // Get the modal instance
            const modal = M.Modal.getInstance(document.getElementById('manual-entry-modal'));
            
            // Clear any existing form data first
            document.getElementById('manual-title').value = '';
            document.getElementById('manual-authors').value = '';
            document.getElementById('manual-publisher').value = '';
            document.getElementById('manual-year').value = '';
            document.getElementById('manual-icon-url').value = '';
            document.getElementById('manual-grade').selectedIndex = 0;
            
            // Clear existing ISBN inputs and start fresh
            document.getElementById('isbn-inputs').innerHTML = '';
            
            // Pre-fill with the provided data
            if (prefillData.title) {
                document.getElementById('manual-title').value = prefillData.title;
            }
            
            if (prefillData.authors) {
                document.getElementById('manual-authors').value = prefillData.authors;
            }
            
            if (prefillData.grade) {
                const gradeSelect = document.getElementById('manual-grade');
                // Find and select the matching grade option
                for (let i = 0; i < gradeSelect.options.length; i++) {
                    if (gradeSelect.options[i].value === prefillData.grade) {
                        gradeSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // Handle ISBN input - create input field(s) with the ISBN data
            if (prefillData.isbn) {
                // Create first ISBN input with the provided ISBN
                addISBNInputWithValue(prefillData.isbn);
            } else {
                // Add one empty ISBN input by default
                addISBNInput();
            }
            
            // Update Materialize labels to show above filled inputs
            M.updateTextFields();
            
            // Update select elements
            M.FormSelect.init(document.querySelectorAll('select'));
            
            // Open the modal
            modal.open();
        }
        
        // Helper function to add ISBN input with a specific value
        function addISBNInputWithValue(isbnValue) {
            const container = document.getElementById('isbn-inputs');
            const newInputRow = document.createElement('div');
            newInputRow.className = 'input-field isbn-input-row';
            newInputRow.style = 'display: flex; align-items: center; margin-bottom: 10px;';
            newInputRow.innerHTML = `
                <input type="text" class="isbn-input validate" placeholder="Enter ISBN (10 or 13 digits)" required value="${isbnValue}">
                <button type="button" class="btn-flat red-text remove-isbn-btn" style="margin-left: 10px;">
                    <i class="material-icons">remove</i>
                </button>
            `;
            
            // Show remove button since we have a value
            newInputRow.querySelector('.remove-isbn-btn').style.display = 'inline-block';
            
            // Show remove button on input focus
            newInputRow.querySelector('input').addEventListener('focus', function () {
                newInputRow.querySelector('.remove-isbn-btn').style.display = 'inline-block';
            });
            
            // Hide remove button when input is empty
            newInputRow.querySelector('input').addEventListener('input', function () {
                if (!this.value.trim()) {
                    newInputRow.querySelector('.remove-isbn-btn').style.display = 'none';
                } else {
                    newInputRow.querySelector('.remove-isbn-btn').style.display = 'inline-block';
                }
            });
            
            // Remove input row on button click
            newInputRow.querySelector('.remove-isbn-btn').addEventListener('click', function () {
                container.removeChild(newInputRow);
            });
            
            container.appendChild(newInputRow);
            M.updateTextFields();
        }
        
        // Add enter key support for search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-query');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchBooks();
                    }
                });
            }
        });
        
        // Edit ISBN metadata modal functions
        function openEditIsbnModal(title, isbn, metaStr) {
            let meta;
            try {
                meta = JSON.parse(metaStr);
            } catch (e) {
                meta = {};
            }
            editIsbnContext = { title, isbn };
            document.getElementById('edit-title').value = meta.title || '';
            document.getElementById('edit-authors').value = (meta.authors && Array.isArray(meta.authors)) ? meta.authors.join(', ') : (meta.authors || '');
            document.getElementById('edit-publisher').value = meta.publisher || '';
            document.getElementById('edit-year').value = meta.year || '';
            document.getElementById('edit-icon-url').value = meta.icon_url || '';
            document.getElementById('edit-notes').value = meta.notes || '';
            M.updateTextFields();
            const modal = M.Modal.getInstance(document.getElementById('edit-isbn-modal'));
            modal.open();
        }
        async function submitEditIsbn() {
            const title = editIsbnContext.title;
            const isbn = editIsbnContext.isbn;
            const data = {
                title: document.getElementById('edit-title').value.trim(),
                authors: document.getElementById('edit-authors').value.trim(),
                publisher: document.getElementById('edit-publisher').value.trim(),
                year: document.getElementById('edit-year').value.trim(),
                icon_url: document.getElementById('edit-icon-url').value.trim(),
                notes: document.getElementById('edit-notes').value.trim(),
            };
            // Convert authors to array if not empty
            if (data.authors) {
                data.authors = data.authors.split(',').map(a => a.trim()).filter(Boolean);
            }
            try {
                const response = await fetch(`/api/books/${encodeURIComponent(title)}/${isbn}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    M.toast({ html: result.message, classes: 'green' });
                    const modal = M.Modal.getInstance(document.getElementById('edit-isbn-modal'));
                    modal.close();
                    loadISBNs();
                } else {
                    M.toast({ html: result.error || 'Failed to update ISBN', classes: 'red' });
                }
            } catch (error) {
                console.error('Error updating ISBN:', error);
                M.toast({ html: 'Error updating ISBN', classes: 'red' });
            }
        }
        
        // Materialize modal initialization
        document.addEventListener('DOMContentLoaded', function () {
            var editModalEl = document.getElementById('edit-isbn-modal');
            if (editModalEl) M.Modal.init(editModalEl);
        });

        // Function to download all book icons
            async function downloadAllIcons() {
                if (!confirm('Download all book icons and save them locally? This might take a while.')) {
                    return;
                }
                
                const btn = document.getElementById('download-all-icons-btn');
                btn.disabled = true;
                btn.innerHTML = '<i class="material-icons rotating">sync</i>';
                M.toast({ html: 'Downloading all book icons...', classes: 'blue' });
                
                try {
                    const response = await fetch('/api/images/download-all-icons', {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        M.toast({ html: data.message, classes: 'green' });
                        // Refresh the page to show updated icons
                        loadISBNs();
                    } else {
                        M.toast({ html: data.error || 'Failed to download icons', classes: 'red' });
                    }
                } catch (error) {
                    console.error('Error downloading icons:', error);
                    M.toast({ html: 'Error downloading icons', classes: 'red' });
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="large material-icons">image</i>';                }
            }

    // Initialize mobile grade chip navigation
    function initializeMobileGradeChips() {
        const gradeChips = document.querySelectorAll('.grade-chip');
        const gradeContents = document.querySelectorAll('.grade-content');
        
        gradeChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                
                // Remove active class from all chips
                gradeChips.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked chip
                this.classList.add('active');
                
                // Hide all grade content sections
                gradeContents.forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show target content section
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.style.display = 'block';
                }
                
                // Scroll the active chip into view
                this.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            });
        });
        
        // Initialize - show the active chip's content
        const activeChip = document.querySelector('.grade-chip.active');
        if (activeChip) {
            const targetId = activeChip.getAttribute('data-target');
            gradeContents.forEach(content => {
                content.style.display = content.id === targetId ? 'block' : 'none';
            });
        }
    }
    </script>

    <!-- Manual Book Entry Modal -->
    <div id="manual-entry-modal" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4>Add Book Manually</h4>
            <p>Book not found? Add it manually with your own details.</p>
            
            <div class="row">
                <div class="input-field col s12">
                    <input id="manual-title" type="text" class="validate" required>
                    <label for="manual-title">Book Title <span class="red-text">*</span></label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <input id="manual-authors" type="text" class="validate">
                    <label for="manual-authors">Authors (comma-separated)</label>
                    <span class="helper-text">Example: John Smith, Jane Doe</span>
                </div>
            </div>
            
            <div class="row">
                <div class="col s12">
                    <label>ISBNs <span class="red-text">*</span></label>
                    <div id="isbn-inputs">
                        <div class="input-field isbn-input-row" style="display: flex; align-items: center; margin-bottom: 10px;">
                            <input type="text" class="isbn-input validate" placeholder="Enter ISBN (10 or 13 digits)" required>
                            <button type="button" class="btn-flat red-text remove-isbn-btn" style="margin-left: 10px; display: none;">
                                <i class="material-icons">remove</i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn-flat blue-text" onclick="addISBNInput()">
                        <i class="material-icons left">add</i>Add another ISBN
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s6">
                    <input id="manual-publisher" type="text" class="validate">
                    <label for="manual-publisher">Publisher</label>
                </div>
                <div class="input-field col s6">
                    <input id="manual-year" type="text" class="validate">
                    <label for="manual-year">Year</label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <input id="manual-icon-url" type="url" class="validate">
                    <label for="manual-icon-url">Cover Image URL</label>
                    <span class="helper-text">Optional: Direct link to book cover image</span>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <select id="manual-grade">
                        <option value="" disabled selected>Select Grade Level (Optional)</option>
                        <option value="Kindergarten">Kindergarten</option>
                        <option value="1st Grade">1st Grade</option>
                        <option value="2nd Grade">2nd Grade</option>
                        <option value="3rd Grade">3rd Grade</option>
                        <option value="4th Grade">4th Grade</option>
                        <option value="5th Grade">5th Grade</option>
                        <option value="6th Grade">6th Grade</option>
                        <option value="7th Grade">7th Grade</option>
                        <option value="8th Grade">8th Grade</option>
                        <option value="9th Grade">9th Grade</option>
                        <option value="10th Grade">10th Grade</option>
                        <option value="11th Grade">11th Grade</option>
                        <option value="12th Grade">12th Grade</option>
                    </select>
                    <label>Grade Level</label>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="modal-close waves-effect waves-grey btn-flat">Cancel</button>
            <button type="button" class="waves-effect waves-green btn blue" onclick="submitManualEntry()">
                <i class="material-icons left">save</i>Add Book
            </button>
        </div>
    </div>

    <!-- Edit ISBN Modal -->
    <div id="edit-isbn-modal" class="modal modal-fixed-footer">
        <div class="modal-content">
            <h4>Edit ISBN Metadata</h4>
            <div class="row">
                <div class="input-field col s12">
                    <input id="edit-title" type="text" class="validate" required>
                    <label for="edit-title">Book Title <span class="red-text">*</span></label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="edit-authors" type="text" class="validate">
                    <label for="edit-authors">Authors (comma-separated)</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s6">
                    <input id="edit-publisher" type="text" class="validate">
                    <label for="edit-publisher">Publisher</label>
                </div>
                <div class="input-field col s6">
                    <input id="edit-year" type="text" class="validate">
                    <label for="edit-year">Year</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="edit-icon-url" type="url" class="validate">
                    <label for="edit-icon-url">Icon URL</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="edit-notes" type="text" class="validate">
                    <label for="edit-notes">Notes</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-close btn-flat">Cancel</button>
            <button class="btn blue" onclick="submitEditIsbn()"><i class="material-icons left">save</i>Save Changes</button>
        </div>
    </div>
</body>

</html>