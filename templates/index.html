<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Price Tracker</title>

    <!-- Material Design CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        .header-color {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-panel {
            margin: 1rem 0;
        }

        .price-high {
            color: #e53e3e;
            font-weight: bold;
        }

        .price-medium {
            color: #d69e2e;
            font-weight: bold;
        }

        .price-low {
            color: #38a169;
            font-weight: bold;
        }

        .source-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .source-abebooks {
            background-color: #3182ce;
        }

        .source-christianbook {
            background-color: #d53f8c;
        }

        .source-rainbowresource {
            background-color: #38a169;
        }

        .source-camelcamelcamel {
            background-color: #ed8936;
        }

        .status-success {
            color: #38a169;
        }

        .status-failed {
            color: #e53e3e;
        }

        .search-highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .price-cell {
            font-size: 1.1em;
            font-weight: 600;
        }

        .book-title {
            color: #2d3748;
            font-weight: 600;
        }

        .isbn-code {
            font-family: 'Courier New', monospace;
            background-color: #edf2f7;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .refresh-indicator {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .isbn-card {
            transition: box-shadow 0.3s ease;
        }

        .isbn-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .price-source-card {
            transition: background-color 0.2s ease;
        }

        .price-source-card:hover {
            background-color: #f0f0f0 !important;
        }

        .source-badge.source-abebooks {
            background-color: #3182ce;
        }

        .source-badge.source-christianbook {
            background-color: #d53f8c;
        }        .source-badge.source-rainbowresource {
            background-color: #38a169;
        }

        .btn-large.green {
            background-color: #4caf50 !important;
        }

        .btn-large.orange {
            background-color: #ff9800 !important;
        }

        .btn-large.red {
            background-color: #f44336 !important;
        }

        .book-image-container img {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .isbn-card {
            transition: all 0.3s ease;
        }        .isbn-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        /* Nested collapsible styling */
        .collapsible li.active .collapsible-header {
            background-color: #e3f2fd !important;
        }

        .collapsible .collapsible .collapsible-header {
            border-bottom: 1px solid #e0e0e0;
        }

        .collapsible .collapsible .collapsible-body {
            background-color: #fafbfc;
        }

        /* Source badge adjustments for compact view */
        .source-badge {
            display: inline-block;
            white-space: nowrap;
        }        /* Compact price display */
        .price-compact {
            font-family: monospace;
        }        /* Enhanced responsive tab styling */
        .tabs .tab {
            min-width: 60px;
        }
        
        .tabs .tab a {
            font-size: 12px;
            padding: 0 8px;
            transition: all 0.3s ease;
        }

        /* Search and Filter Styles */
        .filter-chips {
            margin-top: 0.5rem;
        }

        .filter-chip {
            min-height: 32px;
            line-height: 32px;
            transition: all 0.2s ease;
        }

        .filter-chip:hover {
            background-color: #e0e0e0 !important;
        }

        .filter-chip.active {
            background-color: #2196f3 !important;
            color: white !important;
        }

        .search-results-info {
            opacity: 0.8;
        }        .filter-hidden {
            display: none !important;
        }

        .book-card-hidden {
            display: none !important;
        }

        .filter-active-indicator {
            background-color: #ff9800 !important;
            color: white !important;
        }

        /* Mobile filter adjustments */
        @media only screen and (max-width: 600px) {
            .filter-chips {
                justify-content: center;
            }
            
            .filter-chips span {
                display: none; /* Hide "Quick Filters:" label on mobile */
            }
            
            .filter-chip {
                margin-bottom: 0.25rem;
            }
        }

        /* Desktop enhancements (>= 992px) */
        @media only screen and (min-width: 992px) {
            .tabs {
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                border-radius: 8px;
                overflow: hidden;
            }
            
            .tabs .tab a {
                background-color: #f5f5f5;
                margin: 0 2px;
                border-radius: 6px;
                font-weight: 500;
                transition: all 0.3s ease;
            }
            
            .tabs .tab a:hover {
                background-color: #e0e0e0;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            
            .tabs .tab a.active {
                background-color: #2196f3 !important;
                color: white !important;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
                transform: translateY(-2px);
            }
            
            .tabs .indicator {
                display: none; /* Hide default indicator since we're using custom active styling */
            }
        }

        /* Mobile chip navigation (< 992px) */
        @media only screen and (max-width: 991px) {
            .desktop-tabs {
                display: none !important;
            }
            
            .mobile-grade-chips {
                display: block !important;
                padding: 10px 0;
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            .mobile-grade-chips::-webkit-scrollbar {
                height: 4px;
            }
            
            .mobile-grade-chips::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            
            .mobile-grade-chips::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 2px;
            }
            
            .grade-chip {
                display: inline-block;
                margin: 0 4px;
                padding: 8px 16px;
                background-color: #e0e0e0;
                border: none;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                color: #666;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 60px;
                text-align: center;
                white-space: nowrap;
            }
            
            .grade-chip.active {
                background-color: #2196f3;
                color: white;
                font-weight: 600;
                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            }
            
            .grade-chip:hover {
                background-color: #d0d0d0;
            }
            
            .grade-chip.active:hover {
                background-color: #1976d2;
            }
        }

        /* Hide mobile chips by default */
        .mobile-grade-chips {
            display: none;
        }

        /* Extra mobile improvements for smaller screens */
        @media only screen and (max-width: 375px) {
            .container {
                padding: 0 5px;
            }
            
            .book-card-container {
                margin-bottom: 0.5rem;
            }
            
            .book-card-container .card-content {
                padding: 0.5rem !important;
            }
            
            .mobile-book-image .book-image-container {
                width: 50px;
                height: 65px;
                font-size: 8px;
            }
            
            .mobile-book-info .book-title {
                font-size: 0.85rem !important;
            }
            
            .mobile-stats-collapsible .collapsible-header {
                font-size: 0.8rem;
                padding: 0.4rem 0.5rem;
            }
            
            .mobile-stats-grid .col {
                font-size: 0.7rem;
            }
            
            .mobile-stats-grid strong {
                font-size: 0.75rem;
            }
        }

        /* Grade content styling */
        .grade-content {
            padding-top: 20px;
        }

        .grade-content h6 {
            margin-bottom: 15px;
        }        /* Responsive improvements for all screen sizes */
        
        /* Extra small screens (phones, less than 576px) */
        @media only screen and (max-width: 375px) {
            .container {
                padding: 0 8px;
            }
            
            .card-panel {
                margin: 0.5rem 0;
                padding: 12px;
            }
            
            .isbn-card {
                margin-bottom: 1rem !important;
                padding: 0.75rem !important;
                min-height: auto !important;
            }
            
            .tabs .tab a {
                font-size: 8px;
                padding: 0 1px;
                line-height: 48px;
            }
              .book-title {
                font-size: 1.1rem !important;
            }
        }

        /* Small screens (phones, 576px and up) */
        @media only screen and (max-width: 600px) {
            .container {
                padding: 0 10px;
            }
            
            .card-panel {
                margin: 0.5rem 0;
                padding: 15px;
            }
            
            .isbn-card {
                margin-bottom: 1rem !important;
                padding: 0.75rem !important;
                min-height: auto !important;
            }
            
            .tabs .tab a {
                font-size: 9px;
                padding: 0 2px;
                line-height: 48px;
            }
            
            /* Ensure touch targets are at least 48px */
            .btn, .btn-large, .btn-floating {
                min-height: 48px;
                min-width: 48px;
            }
            
            .collapsible-header {
                min-height: 48px;
                padding: 12px 16px;
            }
            
            /* Stack book card content vertically on mobile */
            .book-card-image {
                margin-bottom: 1rem;
            }
            
            .book-stats-grid .col {
                padding: 0 0.25rem;
                margin-bottom: 0.5rem;
            }
            
            /* Reduce font sizes for mobile */
            h5 {
                font-size: 1.8rem;
            }
            
            h6 {
                font-size: 1.2rem;
            }
            
            .book-title {
                font-size: 1.2rem !important;
            }
        }

        /* Medium screens (tablets, 601px to 992px) */
        @media only screen and (min-width: 601px) and (max-width: 992px) {
            .book-stats-grid .col {
                padding: 0 0.5rem;
            }
            
            .card-panel {
                margin: 0.75rem 0;
            }
            
            .tabs .tab a {
                font-size: 11px;
                padding: 0 6px;
            }
        }

        /* Large screens (desktops, 993px and up) */
        @media only screen and (min-width: 993px) {
            .isbn-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
            }
            
            .tabs .tab a {
                font-size: 12px;
                padding: 0 8px;
            }
        }
          /* Book card responsive layout */
        .book-card-container {
            margin-bottom: 1.5rem;
        }
        
        .book-card-image {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .book-image-container {
            width: 100%;
            max-width: 140px;
            height: 180px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
            text-align: center;
        }
          /* Mobile-optimized book card layout */
        @media only screen and (max-width: 600px) {
            /* Reduce card margins and padding */
            .book-card-container {
                margin-bottom: 0.75rem;
            }
            
            .book-card-container .card {
                margin: 0;
            }
            
            .book-card-container .card-content {
                padding: 0.75rem !important;
            }
            
            /* Mobile single-column layout */
            .mobile-book-header {
                display: flex;
                align-items: flex-start;
                margin-bottom: 0.75rem;
            }
            
            .mobile-book-image {
                flex-shrink: 0;
                margin-right: 0.75rem;
            }
            
            .mobile-book-image .book-image-container {
                width: 60px;
                height: 80px;
                font-size: 9px;
            }
            
            .mobile-book-info {
                flex: 1;
                min-width: 0;
            }
            
            .mobile-book-info .book-title {
                font-size: 0.95rem !important;
                line-height: 1.2;
                margin: 0 0 0.25rem 0;
            }
            
            .mobile-book-info .isbn-code {
                font-size: 0.8rem;
                color: #888;
            }
            
            /* Mobile price display */
            .mobile-price-section {
                margin-bottom: 0.5rem;
            }
            
            .mobile-price-section .btn-large {
                width: 100%;
                font-size: 0.85rem !important;
                padding: 0.6rem !important;
                min-height: 48px;
            }
            
            .mobile-price-section .btn-large div {
                font-size: 1rem !important;
            }
            
            /* Hide detailed stats on mobile by default */
            .mobile-stats-collapsible {
                margin-top: 0.5rem;
            }
            
            .mobile-stats-collapsible .collapsible-header {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
                min-height: 48px;
            }
            
            .mobile-stats-collapsible .collapsible-body {
                padding: 0.5rem 0.75rem;
            }
            
            .mobile-stats-grid .col {
                padding: 0 0.15rem;
                font-size: 0.75rem;
                text-align: center;
                margin-bottom: 0.4rem;
            }
            
            .mobile-stats-grid strong {
                font-size: 0.8rem;
                display: block;
            }
            
            .mobile-stats-grid small {
                font-size: 0.65rem;
                color: #666;
            }
            
            /* Compact ISBN breakdown */
            .mobile-isbn-breakdown .collapsible-header {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .mobile-isbn-breakdown .collapsible-body {
                padding: 0.25rem;
            }
        }
        
        .book-stats-grid {
            margin-top: 1rem;
        }
        
        .book-stats-grid .col {
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        /* CSS Grid layout for book cards containers */
        .grade-list {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }
        
        /* Responsive grid for book cards */
        @media (min-width: 600px) {
            .grade-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 992px) {
            .grade-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1200px) {
            .grade-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }
          /* Book card container adjustments */
        .book-card-container {
            width: 100%;
            max-width: none;
        }
        
        /* Desktop layout styles */
        .desktop-book-layout {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .desktop-book-image {
            flex: 0 0 120px;
            width: 120px;
        }
        
        .desktop-book-info {
            flex: 1;
            min-width: 0;
        }
        
        .desktop-book-price {
            flex: 0 0 180px;
            width: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .desktop-stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .desktop-stats-grid .stat-item {
            flex: 1 1 calc(33.333% - 0.5rem);
            min-width: 120px;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        @media (max-width: 1200px) {
            .desktop-stats-grid .stat-item {
                flex: 1 1 calc(50% - 0.5rem);
            }
        }
        
        /* ISBN grid layout */
        .isbn-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0;
        }
        
        .isbn-card {
            flex: 1 1 calc(33.333% - 1rem);
            min-width: 280px;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 1200px) {
            .isbn-card {
                flex: 1 1 calc(50% - 1rem);
            }
        }
        
        @media (max-width: 768px) {
            .isbn-card {
                flex: 1 1 100%;
            }
        }
        
        .isbn-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .isbn-stats .stat-item {
            flex: 1;
            text-align: center;
        }
        
        .book-price-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
          /* Stats cards responsive */
        .stats-grid {
            margin-bottom: 1.5rem;
        }
        
        .stats-grid .card-panel {
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0.5rem 0;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stats-grid .card-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stats-grid .card-panel i {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .stats-grid .card-panel h5 {
            font-size: 1.6rem;
            margin: 4px 0;
            font-weight: 600;
        }
        
        .stats-grid .card-panel p {
            font-size: 0.85rem;
            margin: 0;
            color: #666;
        }
        
        /* Mobile horizontal scrolling for stats */
        @media only screen and (max-width: 600px) {
            .stats-grid.row {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
                margin: 0 -10px;
                padding: 0 10px;
            }
            
            .stats-grid .col {
                flex: 0 0 200px;
                scroll-snap-align: start;
                padding: 0 0.5rem;
            }
            
            .stats-grid .card-panel {
                width: 100%;
                min-width: 180px;
                height: 70px;
            }
            
            .stats-grid .card-panel h5 {
                font-size: 1.4rem;
            }
              .stats-grid .card-panel p {
                font-size: 0.8rem;
            }
        }
        
        /* Tablet responsive improvements */
        @media only screen and (min-width: 601px) and (max-width: 992px) {
            .container {
                padding: 0 15px;
            }
        }

        /* Add subtle scroll indicator for mobile stats */
        @media only screen and (max-width: 600px) {
            .stats-grid.row::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 20px;
                background: linear-gradient(to right, transparent, rgba(255,255,255,0.8));
                pointer-events: none;
                z-index: 1;
            }
            
            .stats-grid.row {
                position: relative;
            }
        }
        
        /* Desktop improvements */
        @media only screen and (min-width: 993px) {
            .stats-grid .card-panel {
                margin: 0.25rem 0;
            }
        }
    </style>
</head>

<body class="grey lighten-4">    <!-- Navigation -->
    <nav class="header-color">
        <div class="nav-wrapper container">
            <a href="/" class="brand-logo">
                <i class="material-icons left">book</i>Book Price Tracker
            </a>
            <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
                <li class="active"><a href="/"><i class="material-icons left">dashboard</i>Dashboard</a></li>
                <li><a href="/admin"><i class="material-icons left">settings</i>Admin</a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <ul class="sidenav" id="mobile-demo">
        <li><div class="user-view">
            <div class="background">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%;"></div>
            </div>
            <a href="/"><span class="white-text name">Book Price Tracker</span></a>
        </div></li>
        <li class="active"><a href="/"><i class="material-icons">dashboard</i>Dashboard</a></li>
        <li><a href="/admin"><i class="material-icons">settings</i>Admin</a></li>
    </ul>

    <!-- Main Content -->
    <div class="container" style="margin-top: 2rem;">        <!-- Header Stats -->
        <div class="row stats-grid">
            <div class="col s12 m4 l4">
                <div class="card-panel center-align white hoverable tooltipped" 
                     data-position="bottom" 
                     data-tooltip="Total number of unique books being tracked for price monitoring">
                    <i class="material-icons blue-text">library_books</i>
                    <h5 class="blue-text">{{ books|length }}</h5>
                    <p>Books Tracked</p>
                </div>
            </div>
            <div class="col s12 m4 l4">
                <div class="card-panel center-align white hoverable tooltipped" 
                     data-position="bottom" 
                     data-tooltip="Total number of price data points collected from all sources across all books">
                    <i class="material-icons green-text">trending_up</i>
                    <h5 class="green-text">{{ total_records }}</h5>
                    <p>Total Price Records</p>
                </div>
            </div>
            <div class="col s12 m4 l4">
                <div class="card-panel center-align white hoverable tooltipped" 
                     data-position="bottom" 
                     data-tooltip="Automated price updates run daily to ensure you have the latest pricing information">
                    <i class="material-icons orange-text">schedule</i>
                    <h5 class="orange-text">Daily</h5>
                    <p>Update Frequency</p>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        {% if error %}
        <div class="card-panel red lighten-4">
            <span class="red-text"><strong>Error:</strong> {{ error }}</span>
        </div>
        {% endif %}        <!-- Books by Grade Level Section -->
        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">school</i>Books by Grade Level
                            <div class="right">
                                <button class="btn-small blue" onclick="loadISBNData()" style="margin-right: 10px;">
                                    <i class="material-icons left">refresh</i>Refresh
                                </button>
                                <i class="material-icons refresh-indicator" id="isbn-loading"
                                    style="display: none;">autorenew</i>
                            </div>
                        </span>

                        <!-- Search and Filter Section -->
                        <div class="row" style="margin-top: 1.5rem; margin-bottom: 1rem;">
                            <div class="col s12">
                                <div class="card-panel grey lighten-5" style="padding: 1rem;">
                                    <!-- Search Input -->
                                    <div class="row" style="margin-bottom: 0.5rem;">
                                        <div class="col s12 m8 l6">
                                            <div class="input-field" style="margin: 0;">
                                                <i class="material-icons prefix">search</i>
                                                <input id="book-search-input" type="text" placeholder="Search books by title, author, or ISBN...">
                                                <label for="book-search-input">Search Books</label>
                                            </div>
                                        </div>
                                        <div class="col s12 m4 l6">
                                            <div class="search-results-info" id="search-results-info" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                                <!-- Search results count will appear here -->
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filter Chips -->
                                    <div class="row" style="margin-bottom: 0;">
                                        <div class="col s12">
                                            <div class="filter-chips" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                                                <span style="font-size: 0.9rem; color: #666; margin-right: 0.5rem;">Quick Filters:</span>
                                                
                                                <!-- Grade Filter Dropdown -->
                                                <a class="dropdown-trigger btn-small grey lighten-3 black-text" href="#!" data-target="grade-filter-dropdown" style="border-radius: 16px;">
                                                    <i class="material-icons left tiny">school</i>Grade <i class="material-icons right tiny">arrow_drop_down</i>
                                                </a>
                                                <ul id="grade-filter-dropdown" class="dropdown-content" style="min-width: 150px;">
                                                    <li><a href="#!" onclick="setGradeFilter('')">All Grades</a></li>
                                                    <li class="divider"></li>
                                                    <li><a href="#!" onclick="setGradeFilter('Kindergarten')">Kindergarten</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('1st Grade')">1st Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('2nd Grade')">2nd Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('3rd Grade')">3rd Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('4th Grade')">4th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('5th Grade')">5th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('6th Grade')">6th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('7th Grade')">7th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('8th Grade')">8th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('9th Grade')">9th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('10th Grade')">10th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('11th Grade')">11th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('12th Grade')">12th Grade</a></li>
                                                    <li><a href="#!" onclick="setGradeFilter('Unassigned')">Unassigned</a></li>
                                                </ul>

                                                <!-- Price Range Filter -->
                                                <a class="dropdown-trigger btn-small grey lighten-3 black-text" href="#!" data-target="price-filter-dropdown" style="border-radius: 16px;">
                                                    <i class="material-icons left tiny">attach_money</i>Price <i class="material-icons right tiny">arrow_drop_down</i>
                                                </a>                                                <ul id="price-filter-dropdown" class="dropdown-content">
                                                    <li><a href="#!" onclick="setPriceFilter('')">All Prices</a></li>
                                                    <li class="divider"></li>
                                                    <li><a href="#!" onclick="setPriceFilter('Low ($0-$25)')">Low ($0-$25)</a></li>
                                                    <li><a href="#!" onclick="setPriceFilter('Medium ($25-$50)')">Medium ($25-$50)</a></li>
                                                    <li><a href="#!" onclick="setPriceFilter('High ($50+)')">High ($50+)</a></li>
                                                    <li><a href="#!" onclick="setPriceFilter('No Price')">No Price Data</a></li>
                                                </ul>

                                                <!-- Special Filters -->
                                                <button class="btn-small grey lighten-3 black-text filter-chip" onclick="toggleFilter('recentDrops')" style="border-radius: 16px;">
                                                    <i class="material-icons left tiny">trending_down</i>Recent Drops
                                                </button>

                                                <button class="btn-small grey lighten-3 black-text filter-chip" onclick="toggleFilter('hasImage')" style="border-radius: 16px;">
                                                    <i class="material-icons left tiny">image</i>Has Image
                                                </button>

                                                <!-- Clear Filters -->
                                                <button class="btn-small red lighten-1 white-text" onclick="clearAllFilters()" id="clear-filters-btn" style="border-radius: 16px; display: none;">
                                                    <i class="material-icons left tiny">clear</i>Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div><!-- Grade Level Tabs -->
                        <div class="row">
                            <div class="col s12">
                                <!-- Desktop Tabs -->
                                <ul class="tabs desktop-tabs" id="grade-tabs">
                                    <li class="tab col s2 m1 l1"><a href="#unassigned-books" class="truncate">Unassigned</a></li>
                                    <li class="tab col s1 m1 l1"><a class="active" href="#kindergarten-books">K</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-1-books">1st</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-2-books">2nd</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-3-books">3rd</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-4-books">4th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-5-books">5th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-6-books">6th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-7-books">7th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-8-books">8th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-9-books">9th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-10-books">10th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-11-books">11th</a></li>
                                    <li class="tab col s1 m1 l1"><a href="#grade-12-books">12th</a></li>
                                </ul>
                                

                                <!-- Mobile Chip Navigation -->
                                <div class="mobile-grade-chips" id="mobile-grade-chips">
                                    <button class="grade-chip" data-target="unassigned-books">Unassigned</button>
                                    <button class="grade-chip active" data-target="kindergarten-books">K</button>
                                    <button class="grade-chip" data-target="grade-1-books">1st</button>
                                    <button class="grade-chip" data-target="grade-2-books">2nd</button>
                                    <button class="grade-chip" data-target="grade-3-books">3rd</button>
                                    <button class="grade-chip" data-target="grade-4-books">4th</button>
                                    <button class="grade-chip" data-target="grade-5-books">5th</button>
                                    <button class="grade-chip" data-target="grade-6-books">6th</button>
                                    <button class="grade-chip" data-target="grade-7-books">7th</button>
                                    <button class="grade-chip" data-target="grade-8-books">8th</button>
                                    <button class="grade-chip" data-target="grade-9-books">9th</button>
                                    <button class="grade-chip" data-target="grade-10-books">10th</button>
                                    <button class="grade-chip" data-target="grade-11-books">11th</button>
                                    <button class="grade-chip" data-target="grade-12-books">12th</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Content -->
                        <div id="unassigned-books" class="grade-content">
                            <div id="unassigned-list" class="grade-list">
                                <div class="center-align" style="padding: 2rem;">
                                    <div class="preloader-wrapper small active">
                                        <div class="spinner-layer spinner-blue-only">
                                            <div class="circle-clipper left">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="gap-patch">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="circle-clipper right">
                                                <div class="circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="grey-text">Loading book data...</p>
                                </div>
                            </div>
                        </div>

                        <div id="kindergarten-books" class="grade-content">
                            <div id="kindergarten-list" class="grade-list">
                                <!-- Kindergarten books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-1-books" class="grade-content">
                            <div id="grade-1-list" class="grade-list">
                                <!-- 1st grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-2-books" class="grade-content">
                            <div id="grade-2-list" class="grade-list">
                                <!-- 2nd grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-3-books" class="grade-content">
                            <div id="grade-3-list" class="grade-list">
                                <!-- 3rd grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-4-books" class="grade-content">
                            <div id="grade-4-list" class="grade-list">
                                <!-- 4th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-5-books" class="grade-content">
                            <div id="grade-5-list" class="grade-list">
                                <!-- 5th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-6-books" class="grade-content">
                            <div id="grade-6-list" class="grade-list">
                                <!-- 6th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-7-books" class="grade-content">
                            <div id="grade-7-list" class="grade-list">
                                <!-- 7th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-8-books" class="grade-content">
                            <div id="grade-8-list" class="grade-list">
                                <!-- 8th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-9-books" class="grade-content">
                            <div id="grade-9-list" class="grade-list">
                                <!-- 9th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-10-books" class="grade-content">
                            <div id="grade-10-list" class="grade-list">
                                <!-- 10th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-11-books" class="grade-content">
                            <div id="grade-11-list" class="grade-list">
                                <!-- 11th grade books will be loaded here -->
                            </div>
                        </div>

                        <div id="grade-12-books" class="grade-content">
                            <div id="grade-12-list" class="grade-list">
                                <!-- 12th grade books will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Charts Section -->
        {% if charts %}
        <div class="row">
            <!-- Price Comparison Chart -->
            {% if charts.price_comparison %}
            <div class="col s12 m12 l6 xl6">
                <div class="card hoverable">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">bar_chart</i>
                            Price Comparison
                        </span>
                        <div class="center-align">
                            <img src="data:image/png;base64,{{ charts.price_comparison }}" alt="Price Comparison Chart"
                                class="responsive-img">
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Source Summary Chart -->
            {% if charts.source_summary %}
            <div class="col s12 m12 l6 xl6">
                <div class="card hoverable">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">pie_chart</i>
                            Data by Source
                        </span>
                        <div class="center-align">
                            <img src="data:image/png;base64,{{ charts.source_summary }}" alt="Source Summary Chart"
                                class="responsive-img">
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Price Trends Chart -->
            {% if charts.price_trends %}
            <div class="col s12">
                <div class="card hoverable">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">trending_up</i>
                            Price Trends
                        </span>
                        <div class="center-align">
                            <img src="data:image/png;base64,{{ charts.price_trends }}" alt="Price Trends Chart"
                                class="responsive-img">
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

    </div>

    <!-- Footer -->
    <footer class="page-footer header-color" style="margin-top: 3rem;">
        <div class="container">
            <div class="row">
            </div>
        </div>
    </footer>

    <!-- Expose books data to JS -->
    <script id="books-data-json" type="application/json">{{ books|tojson }}</script>
    <script>
        // Parse books data from JSON script tag
        const BOOKS_DATA = JSON.parse(document.getElementById('books-data-json').textContent);
    </script>
    <!-- Material Design JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>        // Initialize Material Design components
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize mobile navigation
            var sidenav = document.querySelectorAll('.sidenav');
            M.Sidenav.init(sidenav);
            
            // Initialize tooltips
            var tooltips = document.querySelectorAll('.tooltipped');
            M.Tooltip.init(tooltips);

            // Initialize dropdowns
            var dropdowns = document.querySelectorAll('.dropdown-trigger');
            M.Dropdown.init(dropdowns);

            // Initialize selects
            var selects = document.querySelectorAll('select');
            M.FormSelect.init(selects);            // Initialize tabs
            var tabsEl = document.querySelectorAll('.tabs');
            M.Tabs.init(tabsEl);

            // Initialize mobile grade chip navigation
            initializeMobileGradeChips();

            // Search and filter functionality
            const searchInput = document.getElementById('search-input');
            const sourceFilter = document.getElementById('source-filter');
            const priceFilter = document.getElementById('price-filter');
            const table = document.getElementById('prices-table');

            if (table) {
                const rows = table.querySelectorAll('tbody tr');

                function filterTable() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const selectedSource = sourceFilter.value;
                    const selectedPriceRange = priceFilter.value;

                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        const source = row.dataset.source;
                        const price = parseFloat(row.dataset.price);

                        let showRow = true;

                        // Search filter
                        if (searchTerm && !text.includes(searchTerm)) {
                            showRow = false;
                        }

                        // Source filter
                        if (selectedSource && source !== selectedSource) {
                            showRow = false;
                        }

                        // Price filter
                        if (selectedPriceRange) {
                            if (selectedPriceRange === 'low' && price >= 25) showRow = false;
                            if (selectedPriceRange === 'medium' && (price < 25 || price > 50)) showRow = false;
                            if (selectedPriceRange === 'high' && price <= 50) showRow = false;
                        }

                        row.style.display = showRow ? '' : 'none';
                    });
                }

                searchInput.addEventListener('input', filterTable);
                sourceFilter.addEventListener('change', filterTable);
                priceFilter.addEventListener('change', filterTable);
            }

            // Load ISBN-grouped data
            loadISBNData();
        });

    // Global variables for filtering
    let allBooksData = []; // Store all books for filtering
    let currentFilters = {
        search: '',
        grade: '',
        price: '',
        recentDrops: false,
        hasImage: false
    };

    // Pagination variables
    let currentPage = 1;
    let booksPerPage = 50;
    let totalBooks = 0;
    let totalPages = 1;
    let allBooksDataPaginated = []; // Stores all book data for pagination

    // Function to load and display book-grouped data organized by grade level
    async function loadISBNData() {
        const loadingIcon = document.getElementById('isbn-loading');
        
        // Clear previous data
        allBooksData = [];
        
        // Clear all grade lists
        const gradeContainers = [
            'unassigned-list', 'kindergarten-list', 'grade-1-list', 'grade-2-list',
            'grade-3-list', 'grade-4-list', 'grade-5-list', 'grade-6-list',
            'grade-7-list', 'grade-8-list', 'grade-9-list', 'grade-10-list',
            'grade-11-list', 'grade-12-list'
        ];
        
        gradeContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<div class="center-align" style="padding: 2rem;"><p class="grey-text">Loading books...</p></div>';
            }
        });

        // try {
        loadingIcon.style.display = 'inline-block';
        
        // Fetch merged dashboard data from single endpoint
        const response = await fetch('/api/dashboard-data');

        if (!response.ok) {
            throw new Error('Failed to load dashboard data');
        }

        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Unknown error loading dashboard data');
        }

        const dashboardData = result.data;
        const booksByGrade = dashboardData.books_by_grade;

        // Mapping from grade names to HTML container IDs
        const gradeMapping = {
            'Unassigned': 'unassigned-list',
            'Kindergarten': 'kindergarten-list',
            '1st Grade': 'grade-1-list',
            '2nd Grade': 'grade-2-list',
            '3rd Grade': 'grade-3-list',
            '4th Grade': 'grade-4-list',
            '5th Grade': 'grade-5-list',
            '6th Grade': 'grade-6-list',
            '7th Grade': 'grade-7-list',
            '8th Grade': 'grade-8-list',
            '9th Grade': 'grade-9-list',
            '10th Grade': 'grade-10-list',
            '11th Grade': 'grade-11-list',
            '12th Grade': 'grade-12-list'
        };            // Clear all containers first
        gradeContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
            }
        });

        // Collect all books from all grades for pagination
        allBooksDataPaginated = [];
        Object.entries(booksByGrade).forEach(([gradeName, booksInGrade]) => {
            booksInGrade.forEach(bookData => {
                bookData.assigned_grade = gradeName; // Ensure grade is set
                allBooksDataPaginated.push(bookData);
                allBooksData.push(bookData); // Keep original array for filtering
            });
        });

        // Set up pagination
        totalBooks = allBooksDataPaginated.length;
        updatePagination();

        // Render current page
        renderCurrentPage();

        // Initialize Material Design components after adding HTML
        M.Dropdown.init(document.querySelectorAll('.dropdown-trigger'));
        M.Collapsible.init(document.querySelectorAll('.collapsible'));            // Initialize lazy loading for images after DOM is ready
        initializeLazyImageLoading();

        // } catch (error) {
        //     console.error('Error loading book data:', error);
        //     gradeContainers.forEach(containerId => {
        //         const container = document.getElementById(containerId);
        //         if (container) {
        //             container.innerHTML = `
        //                 <div class="center-align" style="padding: 2rem;">
        //                     <i class="material-icons large red-text">error</i>
        //                     <h5 class="red-text">Error Loading Data</h5>
        //                     <p class="grey-text">${error.message}</p>
        //                     <button class="btn blue" onclick="loadISBNData()">
        //                         <i class="material-icons left">refresh</i>Retry
        //                     </button>
        //                 </div>
        //             `;
        //         }
        //     });
        // } finally {
        //     loadingIcon.style.display = 'none';
        //     // Apply any active filters after loading
        //     if (typeof applyFilters === 'function') {
        //         applyFilters();
        //     }
        // }
    }    // Generate HTML for a single book card using responsive mobile-first design
    function generateBookHTML(bookData) {
        // Pre-compute common values to avoid repeated calculations
        const bestPrice = bookData.best_current_price;
        const priceClass = bestPrice > 50 ? 'red' : bestPrice > 25 ? 'orange' : 'green';
        const cleanTitle = bookData.title.replace(/[^a-zA-Z0-9]/g, '');
        const escapedTitle = bookData.title.replace(/'/g, "\\'");
        const isbnCount = bookData.isbns ? bookData.isbns.length : 0;
        const isbnText = `${isbnCount} ISBN${isbnCount !== 1 ? 's' : ''}`;
        const sourceCount = bookData.sources ? bookData.sources.length : 0;
        const firstIsbn = bookData.isbns && bookData.isbns.length > 0 ? bookData.isbns[0] : '';
        
        // Pre-compute price displays
        const avgPriceDisplay = bookData.avg_current_price 
            ? `<strong class="purple-text">$${bookData.avg_current_price.toFixed(2)}</strong><br><small>Avg Price</small>`
            : `<strong class="grey-text">N/A</strong><br><small>Avg Price</small>`;
        
        const lowestPriceDisplay = bookData.lowest_price_ever 
            ? `<strong class="red-text">$${bookData.lowest_price_ever.toFixed(2)}</strong><br><small>Lowest Ever</small>`
            : `<strong class="grey-text">N/A</strong><br><small>Lowest Ever</small>`;
            
        const highestPriceDisplay = bookData.highest_price_ever 
            ? `<strong class="teal-text">$${bookData.highest_price_ever.toFixed(2)}</strong><br><small>Highest Ever</small>`
            : `<strong class="grey-text">N/A</strong><br><small>Highest Ever</small>`;

        // Pre-compute best price button
        const bestPriceButton = bestPrice ? (
            bookData.best_price_url 
                ? `<a href="${bookData.best_price_url}" target="_blank" class="btn-large ${priceClass} waves-effect waves-light" style="margin-bottom: 0.5rem; border-radius: 8px; padding: 1rem; text-align: center; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60px; width: 100%;">
                    <div style="font-size: 1.5rem; font-weight: 600; line-height: 1.2;">$${bestPrice.toFixed(2)}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Best Price</div>
                   </a>`
                : `<div class="btn-large ${priceClass} disabled" style="margin-bottom: 0.5rem; border-radius: 8px; padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60px; width: 100%;">
                    <div style="font-size: 1.5rem; font-weight: 600; line-height: 1.2;">$${bestPrice.toFixed(2)}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Best Price</div>
                   </div>`
        ) : `<div class="btn-large grey disabled" style="margin-bottom: 0.5rem; border-radius: 8px; padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60px; width: 100%;">
                <div style="font-size: 1.2rem; font-weight: 600; line-height: 1.2;">N/A</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">No Price Data</div>
              </div>`;

        // Build the complete HTML using template literal for better performance
        return `<div class="book-card-container">
            <div class="card hoverable" data-book-title="${cleanTitle}">
                <div class="card-content">
                    <!-- Desktop Layout (hidden on mobile) -->
                    <div class="desktop-book-layout hide-on-small-only">
                        <!-- Book Image Section -->
                        <div class="desktop-book-image">                            <div id="book-image-${cleanTitle}" class="book-image-container" data-lazy-image="true" data-book-title="${cleanTitle}" data-isbns='${JSON.stringify(bookData.isbns)}' data-icon-url="${bookData.icon_url || ''}">
                                <div class="center-align" style="color: #ccc; padding: 1rem;">
                                    <i class="material-icons" style="font-size: 2rem;">image</i>
                                    <br><small>Loading...</small>
                                </div>
                            </div>
                            <div id="image-actions-${cleanTitle}" class="image-actions center-align" style="display: none; margin-top: 0.5rem;">
                                <a class="dropdown-trigger btn-small orange waves-effect waves-light" href="#!" data-target="image-dropdown-${cleanTitle}" style="width: 100%; min-height: 48px;">
                                    <i class="material-icons left">image</i>Get Image
                                </a>
                                <ul id="image-dropdown-${cleanTitle}" class="dropdown-content">
                                    <li><a href="#!" onclick="downloadBookImageForBook('${escapedTitle}', '${firstIsbn}', 'abebooks')">AbeBooks</a></li>
                                    <li><a href="#!" onclick="downloadBookImageForBook('${escapedTitle}', '${firstIsbn}', 'christianbook')">ChristianBook</a></li>
                                    <li><a href="#!" onclick="downloadBookImageForBook('${escapedTitle}', '${firstIsbn}', 'rainbowresource')">RainbowResource</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Book Info Section -->
                        <div class="desktop-book-info">
                            <h6 class="book-title" style="margin: 0 0 0.5rem 0;">${bookData.title}</h6>
                            <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">
                                <span class="isbn-code">${isbnText}</span>
                            </p>
                            
                            <!-- Book Stats Grid -->
                            <div class="desktop-stats-grid">
                                <div class="stat-item">
                                    <strong class="blue-text">${sourceCount}</strong>
                                    <br><small>Sources</small>
                                </div>
                                <div class="stat-item">
                                    <strong class="green-text">${bookData.successful_records || 0}/${bookData.total_records || 0}</strong>
                                    <br><small>Success Rate</small>
                                </div>
                                <div class="stat-item">
                                    <strong class="orange-text">${bookData.current_price_count || 0}</strong>
                                    <br><small>Valid Prices</small>
                                </div>
                                <div class="stat-item">${avgPriceDisplay}</div>
                                <div class="stat-item">${lowestPriceDisplay}</div>
                                <div class="stat-item">${highestPriceDisplay}</div>
                            </div>
                        </div>
                          
                        <!-- Price Section -->
                        <div class="desktop-book-price">${bestPriceButton}</div>
                    </div>
                    
                    <!-- Mobile Layout (visible only on small screens) -->
                    <div class="hide-on-med-and-up">
                        <div class="mobile-book-layout">
                            <div class="mobile-book-header row" style="margin-bottom: 1rem;">
                                <div class="col s8">
                                    <h6 class="book-title" style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">${bookData.title}</h6>
                                    <p style="margin: 0; color: #666; font-size: 0.85rem;">
                                        <span class="isbn-code">${isbnText}</span>
                                    </p>
                                </div>
                                <div class="col s4">                                    <div id="book-image-mobile-${cleanTitle}" class="book-image-container center-align" data-lazy-image="true" data-book-title="${cleanTitle}" data-isbns='${JSON.stringify(bookData.isbns)}' data-icon-url="${bookData.icon_url || ''}">
                                        <div class="center-align" style="color: #ccc; padding: 0.5rem;">
                                            <i class="material-icons" style="font-size: 1.5rem;">image</i>
                                            <br><small>Loading...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mobile Stats -->
                            <div class="book-stats-grid row" style="margin-bottom: 1rem;">
                                <div class="col s6 center-align">
                                    <strong class="blue-text">${sourceCount}</strong><br><small>Sources</small>
                                </div>
                                <div class="col s6 center-align">
                                    <strong class="orange-text">${bookData.current_price_count || 0}</strong><br><small>Valid Prices</small>
                                </div>
                            </div>
                            
                            <!-- Mobile Price Section -->
                            <div class="book-price-section">${bestPriceButton}</div>
                            
                            <!-- Mobile Image Actions -->
                            <div id="image-actions-mobile-${cleanTitle}" class="image-actions center-align" style="display: none; margin-top: 0.5rem;">
                                <a class="dropdown-trigger btn-small orange waves-effect waves-light" href="#!" data-target="image-dropdown-mobile-${cleanTitle}" style="width: 100%;">
                                    <i class="material-icons left">image</i>Get Image
                                </a>
                                <ul id="image-dropdown-mobile-${cleanTitle}" class="dropdown-content">
                                    <li><a href="#!" onclick="downloadBookImageForBook('${escapedTitle}', '${firstIsbn}', 'abebooks')">AbeBooks</a></li>
                                    <li><a href="#!" onclick="downloadBookImageForBook('${escapedTitle}', '${firstIsbn}', 'christianbook')">ChristianBook</a></li>
                                    <li><a href="#!" onclick="downloadBookImageForBook('${escapedTitle}', '${firstIsbn}', 'rainbowresource')">RainbowResource</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
                                        `}
                                    </div>
                                    <div class="stat-item">                                        ${bookData.highest_price_ever ? `
                                            <strong class="teal-text">$${bookData.highest_price_ever.toFixed(2)}</strong>
                                            <br><small>Highest Ever</small>
                                        ` : `
                                            <strong class="grey-text">N/A</strong>
                                            <br><small>Highest Ever</small>
                                        `}
                                    </div>
                                </div>
                            </div>
                              
                            <!-- Price Section -->
                            <div class="desktop-book-price">
                                ${bestPrice ? `
                                    ${bookData.best_price_url ? `
                                        <a href="${bookData.best_price_url}" target="_blank" class="btn-large ${priceClass} waves-effect waves-light" style="margin-bottom: 0.5rem; border-radius: 8px; padding: 1rem; text-align: center; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60px; width: 100%;">
                                            <div style="font-size: 1.5rem; font-weight: 600; line-height: 1.2;">
                                                $${bestPrice.toFixed(2)}
                                            </div>
                                            <div style="font-size: 0.8rem; opacity: 0.9;">
                                                Best Price
                                            </div>
                                        </a>
                                    ` : `
                                        <div class="btn-large ${priceClass} disabled" style="margin-bottom: 0.5rem; border-radius: 8px; padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60px; width: 100%;">
                                            <div style="font-size: 1.5rem; font-weight: 600; line-height: 1.2;">
                                                $${bestPrice.toFixed(2)}
                                            </div>
                                            <div style="font-size: 0.8rem; opacity: 0.9;">
                                                Best Price
                                            </div>
                                        </div>
                                    `}
                                ` : `
                                    <div class="btn-large grey disabled" style="margin-bottom: 0.5rem; border-radius: 8px; padding: 1rem; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60px; width: 100%;">
                                        <div style="font-size: 1.2rem; font-weight: 600; line-height: 1.2;">
                                            N/A
                                        </div>
                                        <div style="font-size: 0.8rem; opacity: 0.9;">
                                            No Price Data
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Mobile Layout (visible only on small screens) -->
                        <div class="hide-on-med-and-up">
                            <!-- Mobile Book Header -->
                            <div class="mobile-book-header">
                                <div class="mobile-book-image">                                    <div id="book-image-mobile-${cleanTitle}" class="book-image-container" data-lazy-image="true" data-book-title="${cleanTitle}" data-isbns='${JSON.stringify(bookData.isbns)}' data-icon-url="${bookData.icon_url || ''}">
                                        <div class="center-align" style="color: #ccc; padding: 0.5rem;">
                                            <i class="material-icons" style="font-size: 1.5rem;">image</i>
                                            <br><small>Loading...</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mobile-book-info">
                                    <h6 class="book-title">${bookData.title}</h6>
                                    <p style="margin: 0;">
                                        <span class="isbn-code">${bookData.isbns.length} ISBN${bookData.isbns.length > 1 ? 's' : ''}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Mobile Price Section -->
                            <div class="mobile-price-section">
                                ${bestPrice ? `
                                    ${bookData.best_price_url ? `
                                        <a href="${bookData.best_price_url}" target="_blank" class="btn-large ${priceClass} waves-effect waves-light" style="border-radius: 8px; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                            <div style="font-size: 1.2rem; font-weight: 600; line-height: 1.2;">
                                                $${bestPrice.toFixed(2)}
                                            </div>
                                            <div style="font-size: 0.75rem; opacity: 0.9;">
                                                Best Price - Tap to View
                                            </div>
                                        </a>
                                    ` : `
                                        <div class="btn-large ${priceClass} disabled" style="border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                            <div style="font-size: 1.2rem; font-weight: 600; line-height: 1.2;">
                                                $${bestPrice.toFixed(2)}
                                            </div>
                                            <div style="font-size: 0.75rem; opacity: 0.9;">
                                                Best Price
                                            </div>
                                        </div>
                                    `}
                                ` : `
                                    <div class="btn-large grey disabled" style="border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div style="font-size: 1.1rem; font-weight: 600; line-height: 1.2;">
                                            N/A
                                        </div>
                                        <div style="font-size: 0.75rem; opacity: 0.9;">
                                            No Price Data
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- Mobile Stats Collapsible -->
                            <ul class="collapsible mobile-stats-collapsible" style="box-shadow: none; margin: 0;">
                                <li>
                                    <div class="collapsible-header">
                                        <i class="material-icons">assessment</i>
                                        <span>Book Details</span>
                                    </div>
                                    <div class="collapsible-body">
                                        <div class="row mobile-stats-grid" style="margin-bottom: 0;">
                                            <div class="col s4">
                                                <strong class="blue-text">${bookData.sources.length}</strong>
                                                <small>Sources</small>
                                            </div>
                                            <div class="col s4">
                                                <strong class="green-text">${bookData.successful_records}/${bookData.total_records}</strong>
                                                <small>Success</small>
                                            </div>
                                            <div class="col s4">
                                                <strong class="orange-text">${bookData.current_price_count || 0}</strong>
                                                <small>Valid Prices</small>
                                            </div>
                                            <div class="col s4">
                                                ${bookData.avg_current_price ? `
                                                    <strong class="purple-text">$${bookData.avg_current_price.toFixed(2)}</strong>
                                                    <small>Avg Price</small>
                                                ` : `
                                                    <strong class="grey-text">N/A</strong>
                                                    <small>Avg Price</small>
                                                `}
                                            </div>
                                            <div class="col s4">
                                                ${bookData.lowest_price_ever ? `
                                                    <strong class="red-text">$${bookData.lowest_price_ever.toFixed(2)}</strong>
                                                    <small>Lowest Ever</small>
                                                ` : `
                                                    <strong class="grey-text">N/A</strong>
                                                    <small>Lowest Ever</small>
                                                `}
                                            </div>
                                            <div class="col s4">
                                                ${bookData.highest_price_ever ? `
                                                    <strong class="teal-text">$${bookData.highest_price_ever.toFixed(2)}</strong>
                                                    <small>Highest Ever</small>
                                                ` : `
                                                    <strong class="grey-text">N/A</strong>
                                                    <small>Highest Ever</small>
                                                `}
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                            
                            <!-- Mobile Image Actions -->
                            <div id="image-actions-mobile-${cleanTitle}" class="image-actions center-align" style="display: none; margin-top: 0.5rem;">
                                <a class="dropdown-trigger btn-small orange waves-effect waves-light" href="#!" data-target="image-dropdown-mobile-${bookData.title.replace(/[^a-zA-Z0-9]/g, '')}" style="width: 100%; min-height: 48px;">
                                    <i class="material-icons left">image</i>Get Image
                                </a>
                                <ul id="image-dropdown-mobile-${bookData.title.replace(/[^a-zA-Z0-9]/g, '')}" class="dropdown-content">
                                    <li><a href="#!" onclick="downloadBookImageForBook('${bookData.title}', '${bookData.isbns[0]}', 'abebooks')">AbeBooks</a></li>
                                    <li><a href="#!" onclick="downloadBookImageForBook('${bookData.title}', '${bookData.isbns[0]}', 'christianbook')">ChristianBook</a></li>
                                    <li><a href="#!" onclick="downloadBookImageForBook('${bookData.title}', '${bookData.isbns[0]}', 'rainbowresource')">RainbowResource</a></li>
                                </ul>
                            </div>
                        </div>
                        <!-- ISBN Breakdown (desktop) -->
                        <ul class="collapsible hide-on-small-only" style="margin-top: 1rem; box-shadow: none;">
                            <li>
                                <div class="collapsible-header" style="padding: 0.75rem 1rem; min-height: 48px;">
                                    <i class="material-icons">expand_more</i>
                                    <span style="font-weight: 600;">Individual ISBNs (${Object.keys(bookData.isbn_details).length})</span>
                                </div>
                                <div class="collapsible-body" style="padding: 1rem 0;">
                                    <div class="isbn-grid">
        `;

        // Add individual ISBN entries using flexbox grid
        Object.values(bookData.isbn_details).forEach(isbnData => {
            const isbnBestPrice = isbnData.min_price;
            const isbnPriceClass = isbnBestPrice ? 
                (isbnBestPrice > 50 ? 'price-high' : isbnBestPrice > 25 ? 'price-medium' : 'price-low') : 
                'grey-text';            
            
            html += `
                <div class="isbn-card">
                    <div class="card" style="padding: 1rem; border: 1px solid #f0f0f0; height: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span class="isbn-code" style="font-size: 0.9rem;">${isbnData.isbn}</span>
                            ${isbnBestPrice ? `
                                <span class="${isbnPriceClass}" style="font-weight: 600;">$${isbnBestPrice.toFixed(2)}</span>
                            ` : `
                                <span class="grey-text">No Price</span>
                            `}
                        </div>
                        <div class="isbn-stats">
                            <div class="stat-item">
                                <small><strong>${isbnData.sources.length}</strong><br>Sources</small>
                            </div>
                            <div class="stat-item">
                                <small><strong>${isbnData.successful_records}/${isbnData.total_records}</strong><br>Success</small>
                            </div>
                            <div class="stat-item">
                                <small><strong>${isbnData.price_count || 0}</strong><br>Valid Prices</small>
                            </div>
                        </div>
                        ${isbnData.avg_price ? `
                            <div style="margin-bottom: 0.5rem;">
                                <small><strong>Avg:</strong> $${isbnData.avg_price.toFixed(2)}</small>
                                ${isbnData.max_price ? `<span style="margin-left: 1rem;"><small><strong>Max:</strong> $${isbnData.max_price.toFixed(2)}</small></span>` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Collapsible source details for this ISBN -->
                        <ul class="collapsible" style="margin-top: 0.5rem; box-shadow: none; border: 1px solid #e0e0e0;">
                            <li>
                                <div class="collapsible-header" style="padding: 0.5rem 0.75rem; font-size: 0.8rem; min-height: 48px;">
                                    <i class="material-icons tiny">expand_more</i>

                                    <span>Source Details (${isbnData.prices.length})</span>
                                </div>
                                <div class="collapsible-body" style="padding: 0.5rem;">
            `;

            // Group prices by date
            const pricesByDate = {};
            isbnData.prices.forEach(priceData => {
                const date = priceData.timestamp ? new Date(priceData.timestamp).toDateString() : 'Unknown Date';
                if (!pricesByDate[date]) {
                    pricesByDate[date] = [];
                }
                pricesByDate[date].push(priceData);
            });

            // Sort dates (newest first)
            const sortedDates = Object.keys(pricesByDate).sort((a, b) => {
                if (a === 'Unknown Date') return 1;
                if (b === 'Unknown Date') return -1;
                return new Date(b) - new Date(a);
            });

            // Create nested collapsibles for each date
            sortedDates.forEach((date, dateIndex) => {
                const isLatest = dateIndex === 0 && date !== 'Unknown Date';
                const formattedDate = date === 'Unknown Date' ? 'Unknown Date' : 
                    new Date(date).toLocaleDateString(undefined, { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                
                html += `
                    <ul class="collapsible" style="margin: 0.25rem 0; box-shadow: none; border: 1px solid #e9e9e9;">
                        <li class="${isLatest ? 'active' : ''}">
                            <div class="collapsible-header" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; background: ${isLatest ? '#e3f2fd' : '#f9f9f9'}; min-height: 48px;">
                                <i class="material-icons tiny" style="font-size: 16px;">date_range</i>
                                <span style="font-weight: 500; margin-left: 0.25rem;">${formattedDate}</span>
                                <span class="new badge ${isLatest ? 'blue' : 'grey'} white-text" data-badge-caption="" style="margin-left: auto; font-size: 0.7rem; padding: 0.1rem 0.3rem; min-width: 1.5rem;">${pricesByDate[date].length}</span>
                            </div>
                            <div class="collapsible-body" style="padding: 0.3rem; ${isLatest ? 'display: block;' : ''}">
                `;

                // Add sources for this date - group by source for compact display
                const sourcesByName = {};
                pricesByDate[date].forEach(priceData => {
                    if (!sourcesByName[priceData.source]) {
                        sourcesByName[priceData.source] = [];
                    }
                    sourcesByName[priceData.source].push(priceData);
                });

                Object.entries(sourcesByName).forEach(([sourceName, sourcePrices]) => {
                    // Use the most recent price for this source on this date
                    const priceData = sourcePrices.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0))[0];
                    
                    const sourceClass = priceData.source.toLowerCase().replace(/[^a-z]/g, '');
                    const priceDisplay = priceData.price ? `$${priceData.price.toFixed(2)}` : 'N/A';
                    const priceTextClass = priceData.price ?
                        (priceData.price > 50 ? 'price-high' : priceData.price > 25 ? 'price-medium' : 'price-low') :
                        'grey-text';

                    // Make the whole row clickable if url exists
                    if (priceData.url) {
                        html += `
                            <a href="${priceData.url}" target="_blank" style="text-decoration: none; color: inherit; display: block; margin-bottom: 0.3rem;">
                                <div style="padding: 0.2rem; border: 1px solid #f0f0f0; border-radius: 3px; background: #fafafa; display: flex; justify-content: space-between; align-items: center; min-height: 2rem; cursor: pointer;">
                                    <div style="display: flex; align-items: center; flex: 1;">
                                        <span class="source-badge source-${sourceClass}" style="font-size: 0.7rem; padding: 2px 6px;">${priceData.source}</span>
                                        <span class="${priceTextClass}" style="font-weight: 600; font-size: 0.75rem; margin-left: 0.5rem;">${priceDisplay}</span>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        ${priceData.success === true ?
                                            '<i class="material-icons tiny green-text" style="font-size: 14px;">check_circle</i>' :
                                            '<i class="material-icons tiny red-text" style="font-size: 14px;">error</i>'
                                        }
                                        <i class="material-icons tiny" style="font-size: 14px; margin-left: 0.3rem; color: #1976d2;">open_in_new</i>
                                    </div>
                                </div>
                            </a>
                        `;
                    } else {
                        html += `
                            <div style="margin-bottom: 0.3rem; padding: 0.2rem; border: 1px solid #f0f0f0; border-radius: 3px; background: #fafafa; display: flex; justify-content: space-between; align-items: center; min-height: 2rem;">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <span class="source-badge source-${sourceClass}" style="font-size: 0.7rem; padding: 2px 6px;">${priceData.source}</span>
                                    <span class="${priceTextClass}" style="font-weight: 600; font-size: 0.75rem; margin-left: 0.5rem;">${priceDisplay}</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    ${priceData.success === true ?
                                        '<i class="material-icons tiny green-text" style="font-size: 14px;">check_circle</i>' :
                                        '<i class="material-icons tiny red-text" style="font-size: 14px;">error</i>'
                                    }
                                </div>
                            </div>
                        `;
                    }
                });

                html += `
                            </div>
                        </li>
                    </ul>
                `;
            });
            html += `
                                </div>
                            </li>
                        </ul>
                        
                        <!-- Mobile ISBN Breakdown (compact version) -->
                        <ul class="collapsible mobile-isbn-breakdown hide-on-med-and-up" style="margin-top: 0.5rem; box-shadow: none;">
                            <li>
                                <div class="collapsible-header">
                                    <i class="material-icons">list</i>
                                    <span>Individual ISBNs (${Object.keys(bookData.isbn_details).length})</span>
                                </div>
                                <div class="collapsible-body">
        `;
        });

        // Add simplified mobile ISBN entries
        Object.values(bookData.isbn_details).forEach(isbnData => {
            const isbnBestPrice = isbnData.min_price;
            const isbnPriceClass = isbnBestPrice ? 
                (isbnBestPrice > 50 ? 'price-high' : isbnBestPrice > 25 ? 'price-medium' : 'price-low') : 
                'grey-text';
            
            html += `
                <div style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="isbn-code" style="font-size: 0.8rem; font-weight: 600;">${isbnData.isbn}</div>
                        <div style="font-size: 0.7rem; color: #666;">
                            ${isbnData.sources.length} sources  ${isbnData.successful_records}/${isbnData.total_records} success
                        </div>
                    </div>
                    <div style="text-align: right;">
                        ${isbnBestPrice ? `
                            <div class="${isbnPriceClass}" style="font-weight: 600; font-size: 0.9rem;">$${isbnBestPrice.toFixed(2)}</div>
                        ` : `
                            <div class="grey-text" style="font-size: 0.8rem;">No Price</div>
                        `}
                        ${isbnData.avg_price ? `
                            <div style="font-size: 0.7rem; color: #888;">Avg: $${isbnData.avg_price.toFixed(2)}</div>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        html += `
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
          return html;
    }

    // Load book image for book title using first available ISBN
    async function loadBookImageForBook(bookTitle, isbns, iconUrl) {
        const cleanTitle = bookTitle.replace(/[^a-zA-Z0-9]/g, '');
        const imageId = `book-image-${cleanTitle}`;
        const mobileImageId = `book-image-mobile-${cleanTitle}`;
        const imageElement = document.getElementById(imageId);
        const mobileImageElement = document.getElementById(mobileImageId);
        const imageActionsId = `image-actions-${cleanTitle}`;
        const mobileImageActionsId = `image-actions-mobile-${cleanTitle}`;
        const imageActions = document.getElementById(imageActionsId);
        const mobileImageActions = document.getElementById(mobileImageActionsId);

        // First try the icon_path (local) or icon_url (remote) from books.json
        if (iconUrl && iconUrl.trim() !== "") {
            const imageHTML = `<img src="${iconUrl}" alt="Book cover" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
            if (imageElement) imageElement.innerHTML = imageHTML;
            if (mobileImageElement) mobileImageElement.innerHTML = imageHTML;
            if (imageActions) imageActions.style.display = 'none';
            if (mobileImageActions) mobileImageActions.style.display = 'none';
            return;
        }

        // Try to get existing images for any of the ISBNs
        let imageFound = false;
        for (const isbn of isbns) {
            try {
                const response = await fetch(`/api/images/${isbn}`);
                if (response.ok) {
                    const data = await response.json();
                    for (const [source, imageInfo] of Object.entries(data.images)) {
                        if (imageInfo.exists) {
                            const imageHTML = `<img src="${imageInfo.url}" alt="Book cover" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                            if (imageElement) imageElement.innerHTML = imageHTML;
                            if (mobileImageElement) mobileImageElement.innerHTML = imageHTML;
                            imageFound = true;
                            break;
                        }
                    }
                    if (imageFound) break;
                }
            } catch (error) {
                console.error('Error loading image for ISBN:', isbn, error);
            }
        }

        if (!imageFound) {
            const fallbackHTML = '<i class="material-icons" style="font-size: 1.5rem; color: #ccc;">image</i><br><small>No Image</small>';
            if (imageElement) imageElement.innerHTML = fallbackHTML;
            if (mobileImageElement) mobileImageElement.innerHTML = fallbackHTML;
            if (imageActions) imageActions.style.display = 'block';
            if (mobileImageActions) mobileImageActions.style.display = 'block';
        }
    }

    // Download book image for specific book using primary ISBN and source
    async function downloadBookImageForBook(bookTitle, isbn, source) {
        // Show toast notification
        if (typeof M !== 'undefined' && M.toast) {
            M.toast({ html: `Downloading image for ${bookTitle} from ${source}...`, classes: 'blue' });
        }
        
        try {
            const response = await fetch(`/api/images/${isbn}/${source}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                if (typeof M !== 'undefined' && M.toast) {
                    M.toast({ html: data.message, classes: 'green' });
                }
                // Reload the image for this book
                loadBookImageForBook(bookTitle, [isbn], null);
            } else {
                if (typeof M !== 'undefined' && M.toast) {
                    M.toast({ html: data.error || 'Failed to download image', classes: 'red' });
                }
            }
        } catch (error) {
            console.error('Error downloading image:', error);
            if (typeof M !== 'undefined' && M.toast) {
                M.toast({ html: 'Error downloading image', classes: 'red' });
            }        }
    }

    // Lazy Loading Implementation for Images
    let imageObserver;
    const imageCache = new Map(); // Cache for loaded image URLs
    
    function initializeLazyImageLoading() {
        // Check if Intersection Observer is supported
        if (!('IntersectionObserver' in window)) {
            // Fallback: Load all images immediately for unsupported browsers
            loadAllImagesImmediately();
            return;
        }
        
        // Create intersection observer for lazy loading
        imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const imageContainer = entry.target;
                    const bookTitle = imageContainer.dataset.bookTitle;
                    const isbns = JSON.parse(imageContainer.dataset.isbns || '[]');
                    const iconUrl = imageContainer.dataset.iconUrl || '';
                    
                    // Load the image
                    loadBookImageForBookLazy(bookTitle, isbns, iconUrl, imageContainer);
                    
                    // Stop observing this image container
                    imageObserver.unobserve(imageContainer);
                }
            });
        }, {
            root: null,
            rootMargin: '50px', // Start loading 50px before the image comes into view
            threshold: 0.1
        });
        
        // Find all book image containers and observe them
        const imageContainers = document.querySelectorAll('[data-lazy-image="true"]');
        imageContainers.forEach(container => {
            imageObserver.observe(container);
        });
    }
    
    async function loadBookImageForBookLazy(bookTitle, isbns, iconUrl, containerElement) {
        const cleanTitle = bookTitle.replace(/[^a-zA-Z0-9]/g, '');
        const mobileContainerElement = document.getElementById(`book-image-mobile-${cleanTitle}`);
        
        // Check cache first
        const cacheKey = `${bookTitle}-${isbns.join('-')}`;
        if (imageCache.has(cacheKey)) {
            const cachedImageHTML = imageCache.get(cacheKey);
            containerElement.innerHTML = cachedImageHTML;
            if (mobileContainerElement) {
                mobileContainerElement.innerHTML = cachedImageHTML;
            }
            hideImageActions(cleanTitle);
            return;
        }
        
        // First try the icon_path (local) or icon_url (remote) from books.json
        if (iconUrl && iconUrl.trim() !== "") {
            const imageHTML = `<img src="${iconUrl}" alt="Book cover" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" loading="lazy">`;
            containerElement.innerHTML = imageHTML;
            if (mobileContainerElement) {
                mobileContainerElement.innerHTML = imageHTML;
            }
            imageCache.set(cacheKey, imageHTML);
            hideImageActions(cleanTitle);
            return;
        }

        // Try to get existing images for any of the ISBNs
        let imageFound = false;
        for (const isbn of isbns) {
            try {
                const response = await fetch(`/api/images/${isbn}`);
                if (response.ok) {
                    const data = await response.json();
                    for (const [source, imageInfo] of Object.entries(data.images)) {
                        if (imageInfo.exists) {
                            const imageHTML = `<img src="${imageInfo.url}" alt="Book cover" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" loading="lazy">`;
                            containerElement.innerHTML = imageHTML;
                            if (mobileContainerElement) {
                                mobileContainerElement.innerHTML = imageHTML;
                            }
                            imageCache.set(cacheKey, imageHTML);
                            imageFound = true;
                            break;
                        }
                    }
                    if (imageFound) break;
                }
            } catch (error) {
                console.error('Error loading image for ISBN:', isbn, error);
            }
        }

        if (!imageFound) {
            const fallbackHTML = '<i class="material-icons" style="font-size: 1.5rem; color: #ccc;">image</i><br><small>No Image</small>';
            containerElement.innerHTML = fallbackHTML;
            if (mobileContainerElement) {
                mobileContainerElement.innerHTML = fallbackHTML;
            }
            imageCache.set(cacheKey, fallbackHTML);
            showImageActions(cleanTitle);
        } else {
            hideImageActions(cleanTitle);
        }
    }
    
    function hideImageActions(cleanTitle) {
        const imageActions = document.getElementById(`image-actions-${cleanTitle}`);
        const mobileImageActions = document.getElementById(`image-actions-mobile-${cleanTitle}`);
        if (imageActions) imageActions.style.display = 'none';
        if (mobileImageActions) mobileImageActions.style.display = 'none';
    }
    
    function showImageActions(cleanTitle) {
        const imageActions = document.getElementById(`image-actions-${cleanTitle}`);
        const mobileImageActions = document.getElementById(`image-actions-mobile-${cleanTitle}`);
        if (imageActions) imageActions.style.display = 'block';
        if (mobileImageActions) mobileImageActions.style.display = 'block';
    }
    
    function loadAllImagesImmediately() {
        // Fallback for browsers without Intersection Observer support
        allBooksData.forEach(bookData => {
            let iconUrl = '';
            let isbns = bookData.isbns || [];
            
            // Check for icon_path first (local), then icon_url (remote)
            if (bookData.icon_path) {
                iconUrl = '/' + bookData.icon_path;
            } else if (bookData.icon_url) {
                iconUrl = bookData.icon_url;
            }
            
            if (isbns.length > 0) {
                loadBookImageForBook(bookData.title, isbns, iconUrl);
            }
        });
    }

    // Search and Filter Functions
    function setGradeFilter(grade) {
        currentFilters.grade = grade;
        document.getElementById('grade-filter-text').textContent = grade || 'All Grades';
        document.getElementById('grade-filter-text').className = grade ? 'filter-active' : '';
        applyFilters();
    }

    function setPriceFilter(priceRange) {
        currentFilters.price = priceRange;
        document.getElementById('price-filter-text').textContent = priceRange || 'All Prices';
        document.getElementById('price-filter-text').className = priceRange ? 'filter-active' : '';
        applyFilters();
    }

    function toggleFilter(filterType) {
        currentFilters[filterType] = !currentFilters[filterType];
        const filterChip = document.querySelector(`[onclick="toggleFilter('${filterType}')"]`);
        if (filterChip) {
            if (currentFilters[filterType]) {
                filterChip.classList.add('active');
            } else {
                filterChip.classList.remove('active');
            }
        }
        applyFilters();
    }
    
    function clearAllFilters() {
        // Reset all filters
        currentFilters = {
            search: '',
            grade: '',
            price: '',
            recentDrops: false,
            hasImage: false
        };
        
        // Reset UI elements
        document.getElementById('book-search-input').value = '';
        document.getElementById('grade-filter-text').textContent = 'All Grades';
        document.getElementById('grade-filter-text').className = '';
        document.getElementById('price-filter-text').textContent = 'All Prices';
        document.getElementById('price-filter-text').className = '';
          // Remove active class from filter chips
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
          // Hide clear filters button
        const clearBtn = document.getElementById('clear-filters-btn');
        if (clearBtn) {
            clearBtn.style.display = 'none';
        }
        
        // Apply filters (show all books)
        applyFilters();
    }

    function applyFilters() {
        let filteredBooks = [...allBooksData];
        let activeFilters = [];

        // Apply search filter
        if (currentFilters.search && currentFilters.search.trim()) {
            const searchTerm = currentFilters.search.toLowerCase().trim();
            filteredBooks = filteredBooks.filter(book => {
                const titleMatch = book.title.toLowerCase().includes(searchTerm);
                const authorMatch = book.authors && book.authors.some(author => 
                    author.toLowerCase().includes(searchTerm)
                );
                const isbnMatch = book.isbns && book.isbns.some(isbn => 
                    isbn.toLowerCase().includes(searchTerm)
                );
                return titleMatch || authorMatch || isbnMatch;
            });
            activeFilters.push(`Search: "${currentFilters.search}"`);
        }

        // Apply grade filter
        if (currentFilters.grade) {
            filteredBooks = filteredBooks.filter(book => 
                book.assigned_grade === currentFilters.grade
            );
            activeFilters.push(`Grade: ${currentFilters.grade}`);
        }

        // Apply price filter
        if (currentFilters.price) {
            filteredBooks = filteredBooks.filter(book => {
                const price = book.best_current_price;
                switch (currentFilters.price) {
                    case 'Low ($0-$25)':
                        return price !== null && price <= 25;
                    case 'Medium ($25-$50)':
                        return price !== null && price > 25 && price <= 50;
                    case 'High ($50+)':
                        return price !== null && price > 50;
                    case 'No Price':
                        return price === null || price === undefined;
                    default:
                        return true;
                }
            });
            activeFilters.push(`Price: ${currentFilters.price}`);
        }

        // Apply recent drops filter
        if (currentFilters.recentDrops) {
            filteredBooks = filteredBooks.filter(book => {
                // Check if the book has recent price drops (within last 30 days)
                // This is a simplified check - you might want to enhance this based on your data structure
                return book.lowest_price_date && 
                       new Date(book.lowest_price_date) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            });
            activeFilters.push('Recent Drops');
        }

        // Apply has image filter
        if (currentFilters.hasImage) {
            filteredBooks = filteredBooks.filter(book => {
                return book.icon_url && book.icon_url.trim() !== '';
            });
            activeFilters.push('Has Image');
        }

        // Update the paginated data with filtered results
        allBooksDataPaginated = filteredBooks;
        totalBooks = filteredBooks.length;
        currentPage = 1; // Reset to first page when filters change
        
        // Update pagination and render
        updatePagination();
        renderCurrentPage();
        
        // Update search results info
        updateSearchResults(filteredBooks.length, allBooksData.length, activeFilters);
        
        // Show/hide clear filters button
        const clearBtn = document.getElementById('clear-filters-btn');
        if (clearBtn) {
            clearBtn.style.display = activeFilters.length > 0 ? 'inline-block' : 'none';
        }
    }

    function updateBookDisplay(filteredBooks) {
        // Hide all book cards first
        const allCards = document.querySelectorAll('.book-card-container');
        allCards.forEach(card => {
            card.classList.add('filter-hidden');
        });

        // Show filtered books
        filteredBooks.forEach(book => {
            const cleanTitle = book.title.replace(/[^a-zA-Z0-9]/g, '');
            const bookCards = document.querySelectorAll(`[data-book-title="${cleanTitle}"]`);
            bookCards.forEach(card => {
                const container = card.closest('.book-card-container');
                if (container) {
                    container.classList.remove('filter-hidden');
                }
            });
        });

        // Update grade section visibility
        const gradeContainers = [
            'unassigned-list', 'kindergarten-list', 'grade-1-list', 'grade-2-list',
            'grade-3-list', 'grade-4-list', 'grade-5-list', 'grade-6-list',
            'grade-7-list', 'grade-8-list', 'grade-9-list', 'grade-10-list',
            'grade-11-list', 'grade-12-list'
        ];

        gradeContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                const visibleBooks = container.querySelectorAll('.book-card-container:not(.filter-hidden)');
                const gradeContent = container.closest('.grade-content');
                const gradeTab = document.querySelector(`a[href="#${gradeContent?.id}"]`);
                
                if (visibleBooks.length === 0) {
                    container.innerHTML = '<div class="center-align grey-text" style="padding: 2rem;">No books match current filters</div>';
                    if (gradeTab) gradeTab.style.opacity = '0.5';
                } else {
                    if (gradeTab) gradeTab.style.opacity = '1';
                }
            }
        });

        // Update pagination
        updatePagination(filteredBooks);
    }

    function updateSearchResults(filteredCount, totalCount, activeFilters) {
        const resultsInfo = document.getElementById('search-results-info');
        if (resultsInfo) {
            if (filteredCount === totalCount && activeFilters.length === 0) {
                resultsInfo.innerHTML = '';
                resultsInfo.style.display = 'none';
            } else {
                let html = `<div class="search-results-text">
                    <i class="material-icons left">info</i>
                    Showing ${filteredCount} of ${totalCount} books
                `;
                
                if (activeFilters.length > 0) {
                    html += `  Filters: ${activeFilters.join(', ')}`;
                }                
                html += `</div>`;
                
                resultsInfo.innerHTML = html;
                resultsInfo.style.display = 'block';
            }
        }
    }

    // Initialize search input handler with debouncing
    function initializeSearchInput() {
        const searchInput = document.getElementById('book-search-input');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function(e) {
                // Clear previous timeout
                clearTimeout(searchTimeout);
                  // Debounce search input to avoid excessive filtering
                searchTimeout = setTimeout(() => {
                    currentFilters.search = e.target.value;
                    applyFilters();
                }, 300); // 300ms delay
            });
        }
    }

    // Initialize dropdowns and search after page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Materialize dropdowns
        M.Dropdown.init(document.querySelectorAll('.dropdown-trigger'), {
            coverTrigger: false,
            constrainWidth: false
        });
        
        // Initialize search input
        initializeSearchInput();
        
        // Initialize mobile grade chips
        initializeMobileGradeChips();
    });

    // Initialize mobile grade chip navigation
    function initializeMobileGradeChips() {
        const gradeChips = document.querySelectorAll('.grade-chip');
        const gradeContents = document.querySelectorAll('.grade-content');
        
        gradeChips.forEach(chip => {
            chip.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                
                // Remove active class from all chips
                gradeChips.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked chip
                this.classList.add('active');
                
                // Hide all grade content sections
                gradeContents.forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show target content section
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.style.display = 'block';
                }
                
                // Scroll the active chip into view
                this.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            });
        });
        
        // Initialize - show the active chip's content
        const activeChip = document.querySelector('.grade-chip.active');
        if (activeChip) {
            const targetId = activeChip.getAttribute('data-target');
            gradeContents.forEach(content => {
                content.style.display = content.id === targetId ? 'block' : 'none';
            });
        }
    }

    // Pagination functions
    // currentPage = 1;
    booksPerPage = 0;

    function changePage(delta) {
        const newPage = currentPage + delta;
        const totalPages = Math.ceil(allBooksData.length / booksPerPage);

        if (newPage < 1 || newPage > totalPages) {
            return;
        }

        currentPage = newPage;
        updateBookDisplay(getCurrentPageBooks());
        updatePaginationControls();
    }

    function goToPage(page) {
        currentPage = page;
        updateBookDisplay(getCurrentPageBooks());
        updatePaginationControls();
    }

    function changeBooksPerPage() {
        const select = document.getElementById('books-per-page');
        booksPerPage = parseInt(select.value, 10);
        currentPage = 1; // Reset to first page
        updateBookDisplay(getCurrentPageBooks());
        updatePaginationControls();
    }

    function getCurrentPageBooks() {
        const start = (currentPage - 1) * booksPerPage;
        const end = start + booksPerPage;
        return allBooksData.slice(start, end);
    }

    function updatePaginationControls() {
        const totalPages = Math.ceil(allBooksData.length / booksPerPage);
        const paginationContainer = document.getElementById('pagination-container');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');

        // Update pagination info text
        const paginationInfoText = document.getElementById('pagination-info-text');
        if (paginationInfoText) {
            paginationInfoText.textContent = `Showing page ${currentPage} of ${totalPages}`;
        }

        // Show/hide pagination container
        if (totalPages > 1) {
            paginationContainer.style.display = 'block';
        } else {
            paginationContainer.style.display = 'none';
        }

        // Update active/inactive state of page buttons
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.getElementById(`page-${i}`);
            if (pageButton) {
                if (i === currentPage) {
                    pageButton.classList.add('active');
                    pageButton.classList.remove('waves-effect');
                } else {
                    pageButton.classList.remove('active');
                    pageButton.classList.add('waves-effect');
                }
            }
        }

        // Disable prev/next buttons if on first/last page
        if (prevPageButton) {
            if (currentPage === 1) {
                prevPageButton.classList.add('disabled');
            } else {
                prevPageButton.classList.remove('disabled');
            }
        }

        if (nextPageButton) {
            if (currentPage === totalPages) {
                nextPageButton.classList.add('disabled');
            } else {
                nextPageButton.classList.remove('disabled');
            }
        }
    }

    // Pagination Functions
    function updatePagination() {
        totalPages = booksPerPage === 0 ? 1 : Math.ceil(totalBooks / booksPerPage);
        
        // Show/hide pagination container
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) {
            paginationContainer.style.display = totalPages > 1 ? 'block' : 'none';
        }
        
        // Update pagination info
        const paginationInfo = document.getElementById('pagination-info-text');
        if (paginationInfo) {
            if (booksPerPage === 0) {
                paginationInfo.textContent = `Showing all ${totalBooks} books`;
            } else {
                const startBook = (currentPage - 1) * booksPerPage + 1;
                const endBook = Math.min(currentPage * booksPerPage, totalBooks);
                paginationInfo.textContent = `Showing ${startBook}-${endBook} of ${totalBooks} books (Page ${currentPage} of ${totalPages})`;
            }
        }
        
        // Update pagination buttons
        updatePaginationButtons();
    }
    
    function updatePaginationButtons() {
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        
        // Update prev button
        if (prevButton) {
            if (currentPage <= 1) {
                prevButton.classList.add('disabled');
            } else {
                prevButton.classList.remove('disabled');
            }
        }
        
        // Update next button
        if (nextButton) {
            if (currentPage >= totalPages) {
                nextButton.classList.add('disabled');
            } else {
                nextButton.classList.remove('disabled');
            }
        }
        
        // Update page number buttons (showing current page and surrounding pages)
        const pageButtons = document.querySelectorAll('[id^="page-"]');
        pageButtons.forEach(button => {
            button.style.display = 'none';
            button.classList.remove('active');
        });
        
        // Show relevant page buttons
        const maxPageButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
        
        // Adjust start if we're near the end
        if (endPage - startPage + 1 < maxPageButtons) {
            startPage = Math.max(1, endPage - maxPageButtons + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            let pageButton = document.getElementById(`page-${i}`);
            if (!pageButton) {
                // Create new page button if it doesn't exist
                pageButton = document.createElement('li');
                pageButton.id = `page-${i}`;
                pageButton.innerHTML = `<a href="#!" onclick="goToPage(${i})">${i}</a>`;
                
                // Insert before next button
                const nextButton = document.getElementById('next-page');
                if (nextButton) {
                    nextButton.parentNode.insertBefore(pageButton, nextButton);
                }
            }
            
            pageButton.style.display = 'inline-block';
            if (i === currentPage) {
                pageButton.classList.add('active');
            } else {
                pageButton.classList.remove('active');
                pageButton.classList.add('waves-effect');
            }
        }
    }
    
    function renderCurrentPage() {
        // Clear all containers
        const gradeContainers = [
            'unassigned-list', 'kindergarten-list', 'grade-1-list', 'grade-2-list',
            'grade-3-list', 'grade-4-list', 'grade-5-list', 'grade-6-list',
            'grade-7-list', 'grade-8-list', 'grade-9-list', 'grade-10-list',
            'grade-11-list', 'grade-12-list'
        ];
        
        gradeContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
            }
        });
        
        // Get books for current page
        let booksToShow;
        if (booksPerPage === 0) {
            booksToShow = allBooksDataPaginated;
        } else {
            const startIndex = (currentPage - 1) * booksPerPage;
            const endIndex = startIndex + booksPerPage;
            booksToShow = allBooksDataPaginated.slice(startIndex, endIndex);
        }
        
        // Group books by grade
        const gradeMapping = {
            'Unassigned': 'unassigned-list',
            'Kindergarten': 'kindergarten-list',
            '1st Grade': 'grade-1-list',
            '2nd Grade': 'grade-2-list',
            '3rd Grade': 'grade-3-list',
            '4th Grade': 'grade-4-list',
            '5th Grade': 'grade-5-list',
            '6th Grade': 'grade-6-list',
            '7th Grade': 'grade-7-list',
            '8th Grade': 'grade-8-list',
            '9th Grade': 'grade-9-list',
            '10th Grade': 'grade-10-list',
            '11th Grade': 'grade-11-list',
            '12th Grade': 'grade-12-list'
        };
        
        // Group books by grade for this page
        const booksByGrade = {};
        Object.keys(gradeMapping).forEach(grade => {
            booksByGrade[grade] = [];
        });
        
        booksToShow.forEach(book => {
            const grade = book.assigned_grade || 'Unassigned';
            if (booksByGrade[grade]) {
                booksByGrade[grade].push(book);
            } else {
                booksByGrade['Unassigned'].push(book);
            }
        });
        
        // Render books for each grade
        Object.entries(booksByGrade).forEach(([gradeName, books]) => {
            const containerId = gradeMapping[gradeName];
            const container = document.getElementById(containerId);
            
            if (container && books.length > 0) {
                let gradeHTML = '';
                books.forEach(bookData => {
                    gradeHTML += generateBookHTML(bookData);
                });
                container.innerHTML = gradeHTML;
            }
        });
        
        // Initialize Material Design components
        M.Dropdown.init(document.querySelectorAll('.dropdown-trigger'));
        M.Collapsible.init(document.querySelectorAll('.collapsible'));
        
        // Initialize lazy loading for new images
        initializeLazyImageLoading();
    }
    
    function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            updatePagination();
            renderCurrentPage();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    
    function goToPage(pageNumber) {        if (pageNumber >= 1 && pageNumber <= totalPages) {
            currentPage = pageNumber;
            updatePagination();
            renderCurrentPage();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    
    function changeBooksPerPage() {
        const select = document.getElementById('books-per-page');
        if (select) {
            booksPerPage = parseInt(select.value);
            currentPage = 1; // Reset to first page
            updatePagination();
            renderCurrentPage();
        }
    }

    // Initialize dropdowns and search after page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Materialize dropdowns
        M.Dropdown.init(document.querySelectorAll('.dropdown-trigger'), {
            coverTrigger: false,
            constrainWidth: false
        });
        
        // Initialize search input
        initializeSearchInput();
          // Initialize mobile grade chips
        initializeMobileGradeChips();
          // Debug: Check grades after page load
        setTimeout(() => {
            console.log('=== GRADE DEBUG ===');
            if (typeof allBooksDataPaginated !== 'undefined') {
                console.log('Total books loaded:', allBooksDataPaginated.length);
                const gradeCount = {};
                allBooksDataPaginated.forEach(book => {
                    const grade = book.assigned_grade || 'Unassigned';
                    gradeCount[grade] = (gradeCount[grade] || 0) + 1;
                });
                console.log('Books by grade in allBooksDataPaginated:', gradeCount);
                
                // Check specific grade containers
                ['Kindergarten', '4th Grade', '5th Grade', '6th Grade'].forEach(grade => {
                    const containerMap = {
                        'Kindergarten': 'kindergarten-list',
                        '4th Grade': 'grade-4-list', 
                        '5th Grade': 'grade-5-list', 
                        '6th Grade': 'grade-6-list'
                    };
                    const container = document.getElementById(containerMap[grade]);
                    if (container) {
                        console.log(`${grade} container innerHTML length:`, container.innerHTML.length);
                        console.log(`${grade} first 100 chars:`, container.innerHTML.substring(0, 100));
                    } else {
                        console.log(`${grade} container not found!`);
                    }
                });
            } else {
                console.log('allBooksDataPaginated not defined');
            }
        }, 3000);
    });
</script>
</body>

</html>